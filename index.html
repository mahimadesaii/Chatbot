<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Sales Data Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <meta name="theme-color" content="#1e3a8a">
    <link rel="manifest" href="manifest.json">
    <style>
        /* CSS for Bouncing Dots Animation */
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }

        .bouncing-dots span {
            animation: bounce 1.4s infinite ease-in-out both;
            background-color: #ef4444; 
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
        }

        .bouncing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .bouncing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .bouncing-dots span:nth-child(3) {
            animation-delay: 0s;
        }
    </style>
    <script>
        // Registering a Service Worker for offline capabilities and caching.
        // The service worker file is 'service-worker.js'.
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service worker registered.')) // Log successful registration
                    .catch(err => console.error('Service worker registration failed:', err)); // Log any errors during registration
            });
        }
    </script>
</head>

<body class="bg-blue-900 flex flex-col items-center min-h-screen p-6 text-white pb-28" style="padding-top: 120px;">

    <div class="w-full bg-white py-4 px-6 fixed top-0 left-0 z-50">
        <div class="flex items-center gap-3 justify-start w-full max-w-screen">
            <img src="logo.jpeg" alt="Company Logo" class="w-28 h-18 rounded-md" />
        </div>
    </div>

    <div class="w-full bg-blue-900 text-center fixed top-16 z-20 py-6">
        <h1 class="text-3xl font-bold text-white tracking-wide font-serif">
            BotNova
        </h1>
    </div>

    <div
        class="w-full flex flex-col sm:flex-row sm:flex-wrap items-center justify-center gap-4 mt-10 px-4 sm:px-6 max-w-screen-lg">

        <label for="fileInput"
            class="w-25 h-10 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-semibold transition text-center cursor-pointer flex justify-center items-center">
            Choose file
        </label>

        <div id="fileNameDisplay"
            class="w-40 h-10 flex items-center px-3 bg-white border border-gray-300 rounded text-sm text-black">
            No file chosen
        </div>

        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="hidden" />

        <select id="yearSelect" class="w-40 p-2 rounded bg-white text-black border border-gray-300 focus:outline-none">
            <option value="">Year</option>
        </select>

        <select id="monthSelect" class="w-40 p-2 rounded bg-white text-black border border-gray-300 focus:outline-none">
            <option value="">Month</option>
        </select>

        <select id="productSelect"
            class="w-40 p-2 rounded bg-white text-black border border-gray-300 focus:outline-none">
            <option value="">Product</option>
        </select>

        <select id="querySelect" class="w-60 p-2 rounded bg-white text-black border border-gray-300 focus:outline-none">
            <option value="">Select a Query</option>

            <optgroup label="Insights">
                <option value="nonfocusplants">Plant Sales to Non-Focus States</option>
                <option value="avg">Average Sales per Customer</option>
                <option value="top5customers">Top 5 Customers</option>
                <option value="bottom5customers">Bottom 5 Customers</option>
                <option value="topcustomersstate">Top Customers per State</option>
                <option value="topcustomerscity">Top Customers per City</option>
                <option value="comparecustomersales">Compare Customer Sales</option>
                <option value="top5cities">Top 5 Cities by Sales</option>
                <option value="bottom5cities">Bottom 5 Cities by Sales</option>
                <option value="top5states">Top 5 States by Sales</option>
                <option value="bottom5states">Bottom 5 States by Sales</option>
                <option value="compare">Compare Two Periods</option>
                <option value="comparecities">Compare Sales Between Two Cities</option>
                <option value="comparestates">Compare Sales Between Two States</option>
            </optgroup>

            <optgroup label="General Sales">
                <option value="sales">Total Sales</option>
                <option value="monthly">Monthly Sales</option>
                <option value="quarterly">Quarter-wise Sales</option>
            </optgroup>

            <optgroup label="Detailed Geographic Sales">
                <option value="citywise">City-wise Sales (Ship To)</option>
                <option value="statewise">State-wise Sales (Ship To)</option>
                <option value="specificcity">Sales in a Specific City (Ship To)</option>
                <option value="specificstate">Sales in a Specific State (Ship To)</option>
                <option value="districtbreakdown">Region-wise Breakdown</option>
            </optgroup>

            <optgroup label="Focus Areas">
                <option value="focusstates">Focus States</option>
                <option value="focusproductstates">Focus States (SKU-wise Sales)</option>
            </optgroup>

            <optgroup label="SKU/Product-Based Sales">
                <option value="skusales">SKU-wise Sales</option>
                <option value="stateproductbreakdown">State SKU-wise Sales</option>
            </optgroup>

            <optgroup label="Plant Sales">
                <option value="plant">Plant-wise Sales</option>
            </optgroup>
        </select>

        <button id="sendBtn"
            class="w-25 h-10 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-semibold transition">
            Ask the Bot
        </button>

        <button
            onclick="window.open('https://jsw-my.sharepoint.com/:w:/g/personal/satyen_shah_jsw_in/EcxFXo5GYrlKhaOwr_ESuPcB7dS4q0KvslHtmDN0XyZDJg?e=9gOnRR', '_blank')"
            class="fixed bottom-20 right-4 bg-gray-600 text-white px-3 py-2 rounded-full shadow hover:bg-gray-700 z-50"
            title="User Manual">
            üìù
        </button>

        <button
            onclick="window.open('https://jsw-my.sharepoint.com/:x:/g/personal/satyen_shah_jsw_in/EWcRCojMPkFKiMfB2eLOadEBmjBkDNjSMnJRCo_WrJh5wA?e=qG4Sgn', '_blank')"
            class="fixed bottom-6 right-4 bg-gray-600 text-white px-3 py-2 rounded-full shadow hover:bg-gray-700 z-50"
            title="Sample Data">
            üìä
        </button>

    </div>

    <div id="loadingIndicator"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-5 rounded-lg shadow-xl flex items-center space-x-3 text-black">
            <div class="bouncing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span>Loading and processing data...</span>
        </div>
    </div>

    <div id="chatWindow"
        class="w-full sm:w-[700px] lg:w-[1000px] xl:w-[1250px] mt-8 h-[450px] overflow-y-auto bg-white border border-gray-200 shadow rounded p-5 mb-4 text-base text-black">
    </div>

    <script>
        // Global session object (cleaned up, no longer tracks awaiting user input states)
        const session = {};

        // Get references to file input elements
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        const loadingIndicator = document.getElementById('loadingIndicator');

        // Event listener to update file name display when a file is selected
        fileInput.addEventListener('change', function () {
            const fileName = this.files.length > 0 ? this.files[0].name : "No file chosen";
            fileNameDisplay.textContent = fileName;
        });

        let salesData = []; // Array to hold the parsed sales records from the uploaded file

        // Event listener for file input change: triggered when a user selects a file
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0]; // Get the selected file
            if (!file) return; // If no file is selected, exit

            loadingIndicator.classList.remove('hidden'); // Show loading indicator

            const reader = new FileReader(); // Create a FileReader to read file content

            // Callback function when file reading is complete
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result); // Get file data as a Uint8Array
                const workbook = XLSX.read(data, { type: 'array' }); // Parse workbook from raw data
                const sheet = workbook.Sheets[workbook.SheetNames[0]]; // Get the first sheet
                salesData = XLSX.utils.sheet_to_json(sheet); // Convert sheet data to JSON array

                // Populate filter dropdowns with unique values from the loaded data
                const years = new Set();
                const months = new Set();
                const products = new Set();

                salesData.forEach(r => {
                    if (r.Year) years.add(r.Year);
                    if (r.Month_Name) months.add(r.Month_Name);
                    if (r['Product  Hierarchy - Product']) {
                        products.add(r['Product  Hierarchy - Product']);
                    }
                });
                const sortedYears = Array.from(years).sort((a, b) => b - a); // Sort years descending
                populateSelect('yearSelect', years); // Populate year dropdown
                if (sortedYears.length > 0) {
                    document.getElementById('yearSelect').value = sortedYears[0]; // Set default year to the latest
                }
                populateSelect('monthSelect', months); // Populate month dropdown
                populateSelect('productSelect', products); // Populate product dropdown

                loadingIndicator.classList.add('hidden'); // Hide loading indicator
                addMessage('Bot', 'File loaded! You can now use filters and ask questions.'); // Notify user
            };
            reader.readAsArrayBuffer(file); // Read the file as an ArrayBuffer
        });

        // Helper function to populate a select element with options from a Set
        function populateSelect(id, setValues) {
            const select = document.getElementById(id); // Get the select element by ID
            const placeholder = select.options[0].text; // Store the original placeholder text
            select.innerHTML = `<option value="">${placeholder}</option>`; // Reset dropdown, keeping placeholder
            // Add new options, sorted alphabetically
            Array.from(setValues).sort().forEach(value => {
                select.innerHTML += `<option value="${value}">${value}</option>`;
            });
        }

        // Mapping of full month names/abbreviations to standard 3-letter abbreviations
        const monthMap = {
            january: "Jan", february: "Feb", march: "Mar", april: "Apr",
            may: "May", june: "Jun", july: "Jul", august: "Aug",
            september: "Sep", october: "Oct", november: "Nov", december: "Dec",
            jan: "Jan", feb: "Feb", mar: "Mar", apr: "Apr",
            jun: "Jun", jul: "Jul", aug: "Aug", sep: "Sep",
            oct: "Oct", nov: "Nov", dec: "Dec"
        };

        // Function to filter the global salesData based on selected year, month, and product
        function filterData(month, year, product) {
            return salesData
                .filter(r => (!year || String(r.Year) === String(year))) // Filter by year (if selected)
                .filter(r => (!month || r.Month_Name === month)) // Filter by month (if selected)
                .filter(r => (!product || r['Product  Hierarchy - Product'] === product)); // Filter by product (if selected)
        }

        // Utility function to add messages to the chat window
        function addMessage(sender, text) {
            const chatWindow = document.getElementById('chatWindow'); // Get chat window element
            const div = document.createElement('div'); // Create a new div for the message
            // Apply different styling based on sender (You or Bot)
            div.className = sender === 'You' ? 'text-right mb-2' : 'text-left mb-2';

            const now = new Date(); // Get current timestamp
            // Format timestamp as DD/MM/YYYY HH:MM:SS
            const timestamp = now.toLocaleString('en-GB', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            }).replace(',', '');

            // Set the message content with sender, timestamp, and text
            div.innerHTML = `<span class="font-bold">${sender}</span> <span class="text-gray-500">[${timestamp}]</span>: ${text}`;
            chatWindow.appendChild(div); // Add message to chat window
            chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to the bottom of the chat window
        }

        // Function to open a generic modal for additional user inputs
        function openModal(title, fields, callback) {
            const container = document.getElementById('modalFields'); // Container for modal input fields
            const modalTitle = document.getElementById('modalTitle'); // Modal title element
            modalTitle.innerText = title; // Set modal title
            container.innerHTML = ''; // Clear previous fields

            // Dynamically create input fields or select dropdowns in the modal
            fields.forEach(field => {
                let input;
                if (field.type === 'select') {
                    input = document.createElement('select');
                    input.id = field.id;
                    input.className = 'w-full border border-gray-300 p-2 rounded text-base';
                    input.innerHTML = `<option value="">${field.placeholder}</option>`;
                    field.options.forEach(opt => {
                        input.innerHTML += `<option value="${opt}">${opt}</option>`;
                    });
                } else { // Default to text input if type is not select
                    input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = field.placeholder;
                    input.id = field.id;
                    input.className = 'w-full border border-gray-300 p-2 rounded text-sm';
                }

                const wrapper = document.createElement('div');
                wrapper.appendChild(input);
                container.appendChild(wrapper);
            });

            // Show the modal by removing the 'hidden' class
            document.getElementById('inputModal').classList.remove('hidden');

            // Event handler for the modal's Submit button
            document.getElementById('modalSubmitBtn').onclick = function () {
                // Get values from all input fields within the modal
                const values = fields.map(f => document.getElementById(f.id).value.trim());
                const queryType = document.getElementById('querySelect').value; // Get the currently selected main query

                let isValid = true; // Flag to check if modal inputs are valid

                // Specific validation logic for different query types requiring modal input
                if (queryType === 'comparecustomersales') {
                    const [customer, m1, y1, m2, y2] = values;
                    if (!customer || !y1 || !y2) {
                        alert('Please select customer and both years (months optional).');
                        isValid = false;
                    } else {
                        // Call the compareCustomerSales function with collected data
                        callback(customer, { month: m1 || null, year: y1 }, { month: m2 || null, year: y2 });
                    }
                }
                else if (queryType === 'compare') {
                    const [m1, y1, m2, y2] = values;
                    if (!y1 || !y2) {
                        alert('Please select both years (months optional).');
                        isValid = false;
                    } else {
                        // Construct a query string and pass to handleComparisonQuery
                        const query = `compare ${m1 ? m1 + ' ' : ''}${y1} and ${m2 ? m2 + ' ' : ''}${y2}`;
                        callback(query);
                    }
                }
                else if (queryType === 'comparecities') {
                    const [c1, c2] = values;
                    if (!c1 || !c2) {
                        alert('Please select both cities.');
                        isValid = false;
                    } else {
                        callback(c1, c2); // Call compareCities function
                    }
                }
                else if (queryType === 'comparestates') {
                    const [s1, s2] = values;
                    if (!s1 || !s2) {
                        alert('Please select both states.');
                        isValid = false;
                    } else {
                        callback(s1, s2); // Call compareStates function
                    }
                }
                else if (queryType === 'specificstate') {
                    const [state] = values;
                    if (!state) {
                        alert('Please select a state.');
                        isValid = false;
                    } else {
                        callback(state); // Call showSpecificStateSales function
                    }
                }
                else if (queryType === 'specificcity') {
                    const [city] = values;
                    if (!city) {
                        alert('Please select a city.');
                        isValid = false;
                    } else {
                        callback(city); // Call showSpecificLocationSales function
                    }
                }

                // Close modal only if inputs are valid
                if (isValid) {
                    document.getElementById('inputModal').classList.add('hidden');
                }
            };

            // Event handler for the modal's Cancel button
            document.getElementById('modalCancelBtn').onclick = function () {
                document.getElementById('inputModal').classList.add('hidden'); // Hide the modal
            };
        }

        // Helper function to close the modal
        function closeModal() {
            document.getElementById('inputModal').classList.add('hidden');
        }

        // Helper function for modal submission (mostly handled by onclick in openModal)
        function submitModal() {
            const inputs = [...document.querySelectorAll('#modalFields input')].map(i => i.value.trim());
            closeModal();
            if (typeof window.modalCallback === 'function') {
                window.modalCallback(...inputs);
            }
        }


        // --- Insights Functions ---

        // Function to show plant sales to non-focus states
        function showPlantSalesToNonFocusStates(month, year, product) {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No data found.');

            const plantStatesMap = {}; // Maps plants to states they ship to, to determine "home" state
            const salesBreakdown = {}; // Stores sales to non-home states

            // Step 1: Determine the "home" state for each plant (most common ship-to state)
            filtered.forEach(r => {
                const plant = r['Plant_Name'];
                const state = r['Ship To State Text'];
                if (!plant || !state) return;

                if (!plantStatesMap[plant]) plantStatesMap[plant] = {};
                plantStatesMap[plant][state] = (plantStatesMap[plant][state] || 0) + 1;
            });

            const plantHomeStates = {};
            for (const plant in plantStatesMap) {
                const stateCounts = plantStatesMap[plant];
                // Find the state with the highest count for each plant
                const homeState = Object.entries(stateCounts).sort((a, b) => b[1] - a[1])[0][0];
                plantHomeStates[plant] = homeState;
            }

            // Step 2: Aggregate sales for each plant to states that are NOT its determined "home" state
            filtered.forEach(r => {
                const plant = r['Plant_Name'];
                const toState = r['Ship To State Text'];
                const qty = +r['Net Sales Qty'] || 0;
                if (!plant || !toState || !qty) return;

                const home = plantHomeStates[plant];
                if (toState !== home) { // If the 'Ship To State' is not the plant's 'home' state
                    if (!salesBreakdown[plant]) salesBreakdown[plant] = {};
                    salesBreakdown[plant][toState] = (salesBreakdown[plant][toState] || 0) + qty;
                }
            });

            // Step 3: Format and display the results in a table
            let output = `<h3 class="font-semibold mb-1">Plant-wise Sales to Non-Focus States</h3>`;

            if (Object.keys(salesBreakdown).length === 0) {
                addMessage('Bot', 'No sales found to non-focus states.');
                return;
            }

            for (const plant in salesBreakdown) {
                const stateData = salesBreakdown[plant];
                const sortedStates = Object.entries(stateData).sort((a, b) => b[1] - a[1]); // Sort states by sales quantity

                output += `<div class="mb-2"><strong>${plant}</strong>`;
                output += `<table class="min-w-full text-sm mt-1 mb-3">
            <tr style="background-color: #f3f4f6;">
                <th class="border border-black px-2 py-1">State</th>
                <th class="border border-black px-2 py-1">Sales Qty</th>
            </tr>`;

                sortedStates.forEach(([state, qty]) => {
                    output += `<tr>
                <td class="border border-black px-2 py-1">${state}</td>
                <td class="border border-black px-2 py-1">${qty.toLocaleString()}</td>
            </tr>`;
                });

                output += `</table></div>`;
            }

            addMessage('Bot', output);
        }

        // Function to calculate and display average sales per customer
        function showAverageSales(month, year, product) {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No data found.');

            const totalSales = filtered.reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            // Get unique customer names to count total customers
            const uniqueCustomers = new Set(filtered.map(r => r['Customer Name'])).size;
            if (!uniqueCustomers) return addMessage('Bot', 'No valid customer data.');

            const avg = totalSales / uniqueCustomers; // Calculate average sales
            addMessage('Bot', `Average Net Sales Qty: ${avg.toFixed(2)} MT`); // Display result
        }

        // Function to show top or bottom 5 customers based on sales quantity
        function showTopBottomCustomers(month, year, product, type = 'top') {
            const filtered = filterData(month, year, product);
            const customerSales = {}; // Object to aggregate sales per customer

            filtered.forEach(r => {
                const code = r['Sold To Party'] || 'Unknown';
                const name = r['Customer Name'] || 'Unknown';
                const qty = +r['Net Sales Qty'] || 0;

                if (!customerSales[code]) {
                    customerSales[code] = { name, qty: 0 };
                }
                customerSales[code].qty += qty;
            });

            // Sort customers by sales quantity (descending for top, ascending for bottom)
            let sorted = Object.entries(customerSales).sort((a, b) => b[1].qty - a[1].qty);
            // Slice to get top 5 or bottom 5 (reversed for bottom to display smallest first)
            sorted = type === 'bottom' ? sorted.slice(-5).reverse() : sorted.slice(0, 5);

            // Construct HTML table for display
            let msg = `<h3 class="font-semibold mb-1">${type === 'top' ? 'Top' : 'Bottom'} 5 Customers</h3>`;
            msg += `<table class="min-w-full text-sm mb-4 border border-black border-collapse">
                <tr style="background-color: #f3f4f6;">
                    <th class="border border-black px-2 py-1">Customer Name</th>
                    <th class="border border-black px-2 py-1">Customer Code</th>
                    <th class="border border-black px-2 py-1">Sales Qty (MT)</th>
                </tr>`;
            sorted.forEach(([code, data]) => {
                msg += `<tr>
                    <td class="border border-black px-2 py-1">${data.name}</td>
                    <td class="border border-black px-2 py-1">${code}</td>
                    <td class="border border-black px-2 py-1">${data.qty.toLocaleString()}</td>
                </tr>`;
            });
            msg += `</table>`;

            addMessage('Bot', msg);
        }

        // Function to show the top customer for each state
        function showTopCustomersPerState(month, year, product) {
            const filtered = filterData(month, year, product);
            const stateCustomerMap = {}; // Aggregates sales per customer within each state

            // Group customer sales by state
            filtered.forEach(r => {
                const state = r['Ship To State Text'] || 'Unknown';
                const name = r['Customer Name'] || 'Unknown';
                const code = r['Sold To Party'] || 'N/A';
                const qty = +r['Net Sales Qty'] || 0;

                if (!stateCustomerMap[state]) stateCustomerMap[state] = {};
                if (!stateCustomerMap[state][name]) {
                    stateCustomerMap[state][name] = { code: code, qty: 0 };
                }
                stateCustomerMap[state][name].qty += qty;
            });

            // For each state, find the customer with the highest sales
            const topCustomers = Object.entries(stateCustomerMap).map(([state, customers]) => {
                const sorted = Object.entries(customers).sort((a, b) => b[1].qty - a[1].qty);
                const [custName, info] = sorted[0]; // Get only the top customer
                return {
                    state,
                    customer: custName,
                    code: info.code,
                    qty: info.qty
                };
            });

            // Sort the final list of top customers by their sales quantity in descending order
            topCustomers.sort((a, b) => b.qty - a.qty);

            // Construct HTML table for display
            let msg = `<h3 class="font-semibold mb-1">Top Customers per State</h3>
    <table class="min-w-full text-sm mb-4 border border-black border-collapse">
        <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">State</th>
            <th class="border border-black px-2 py-1">Customer Name</th>
            <th class="border border-black px-2 py-1">Customer Code</th>
            <th class="border border-black px-2 py-1">Sales Qty (MT)</th>
        </tr>`;

            topCustomers.forEach(row => {
                msg += `
        <tr>
            <td class="border border-black px-2 py-1">${row.state}</td>
            <td class="border border-black px-2 py-1">${row.customer}</td>
            <td class="border border-black px-2 py-1">${row.code}</td>
            <td class="border border-black px-2 py-1">${row.qty.toLocaleString()}</td>
        </tr>`;
            });

            msg += '</table>';
            addMessage('Bot', msg);
        }

        // Function to show the top customer for each city
        function showTopCustomersPerCity(month, year, product) {
            const filtered = filterData(month, year, product);
            const cityCustomerMap = {}; // Aggregates sales per customer within each city

            // Aggregate customer sales by city
            filtered.forEach(r => {
                const city = r['Ship To City'] || 'Unknown';
                const name = r['Customer Name'] || 'Unknown';
                const code = r['Sold To Party'] || 'N/A';
                const qty = +r['Net Sales Qty'] || 0;

                if (!cityCustomerMap[city]) cityCustomerMap[city] = {};
                if (!cityCustomerMap[city][name]) {
                    cityCustomerMap[city][name] = { code: code, qty: 0 };
                }
                cityCustomerMap[city][name].qty += qty;
            });

            // For each city, find the customer with the highest sales
            const topCustomers = Object.entries(cityCustomerMap).map(([city, customers]) => {
                const sorted = Object.entries(customers).sort((a, b) => b[1].qty - a[1].qty);
                const [custName, info] = sorted[0]; // Get only the top customer
                return {
                    city,
                    customer: custName,
                    code: info.code,
                    qty: info.qty
                };
            });

            // Sort the final list of top customers by sales quantity in descending order
            topCustomers.sort((a, b) => b.qty - a.qty);

            // Construct HTML table for display
            let msg = `<h3 class="font-semibold mb-1">Top Customers per City</h3>
    <table class="min-w-full text-sm mb-4 border border-black border-collapse">
        <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">City</th>
            <th class="border border-black px-2 py-1">Customer Name</th>
            <th class="border border-black px-2 py-1">Customer Code</th>
            <th class="border border-black px-2 py-1">Sales Qty (MT)</th>
        </tr>`;

            topCustomers.forEach(row => {
                msg += `
        <tr>
            <td class="border border-black px-2 py-1">${row.city}</td>
            <td class="border border-black px-2 py-1">${row.customer}</td>
            <td class="border border-black px-2 py-1">${row.code}</td>
            <td class="border border-black px-2 py-1">${row.qty.toLocaleString()}</td>
        </tr>`;
            });

            msg += '</table>';
            addMessage('Bot', msg);
        }

        // Function to compare sales of a specific customer across two chosen periods
        function compareCustomerSales(customerName, period1, period2, product) {
            // Helper function to get total sales for a given month/year and product for the customer
            const getSales = (month, year) => {
                const normalizedMonth = month ? normalizeMonth(month) : null;
                return filterData(normalizedMonth, year, product)
                    .filter(r => (r['Customer Name'] || '').toLowerCase() === customerName.toLowerCase())
                    .reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            };
            const p1 = { ...period1 }; // Clone period1 object
            const p2 = { ...period2 }; // Clone period2 object

            // Normalize month names (e.g., "January" to "Jan")
            p1.month = p1.month ? normalizeMonth(p1.month) : null;
            p2.month = p2.month ? normalizeMonth(p2.month) : null;

            // Helper to get a comparable numeric value for periods (YearMonth format)
            const getSortableValue = (p) => {
                const monthMap = { Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6, Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12 };
                const m = p.month ? monthMap[p.month.slice(0, 3)] : 0; // Get month number, 0 if no month
                return parseInt(p.year) * 100 + m; // Combine year and month number for sorting
            };

            // Determine which period is earlier chronologically
            let earlier = p1, later = p2;
            if (getSortableValue(p1) > getSortableValue(p2)) {
                [earlier, later] = [p2, p1]; // Swap if p1 is later than p2
            }

            // Fetch sales data for both periods
            const sales1 = getSales(earlier.month, earlier.year);
            const sales2 = getSales(later.month, later.year);

            // Create display labels for the periods
            const label1 = earlier.month ? `${earlier.month.toLowerCase()} ${earlier.year}` : earlier.year;
            const label2 = later.month ? `${later.month.toLowerCase()} ${later.year}` : later.year;

            let percentChange = 'N/A'; // Initialize percentage change
            let colorClass = ''; // Initialize color class for display

            // Calculate percentage change if the earlier period's sales are not zero
            if (sales1 !== 0) {
                const change = ((sales2 - sales1) / sales1) * 100;
                const formattedChange = change.toFixed(2) + '%';
                colorClass = change >= 0 ? 'text-green-600' : 'text-red-600'; // Green for increase, red for decrease
                percentChange = `<span class="${colorClass}">${formattedChange}</span>`;
            }

            // Construct HTML table for comparison results
            const table = `
        <h3 class="font-semibold mb-1">Sales Comparison for <strong>${customerName}</strong></h3>
        <table class="min-w-full text-sm">
            <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Period</th><th class="border border-black px-2 py-1">Sales Qty</th></tr>
            <tr><td class="border border-black px-2 py-1">${label1}</td><td class="border border-black px-2 py-1">${sales1.toLocaleString()}</td></tr>
            <tr><td class="border border-black px-2 py-1">${label2}</td><td class="border border-black px-2 py-1">${sales2.toLocaleString()}</td></tr>
        </table>
        <div class="mt-2 text-sm text-gray-700">Percentage Change: <strong>${percentChange}</strong></div>
    `;

            addMessage('Bot', table); // Display the comparison table
        }

        // Function to display top or bottom 5 cities by sales
        function showTopBottomCities(month, year, product, type = 'top') {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No city data found.');

            const citySales = {}; // Aggregates sales per city
            filtered.forEach(r => {
                const city = r['Ship To City'] || 'Unknown';
                citySales[city] = (citySales[city] || 0) + (+r['Net Sales Qty'] || 0);
            });

            // Sort cities by sales quantity
            const sorted = Object.entries(citySales).sort((a, b) => b[1] - a[1]);
            // Get top 5 or bottom 5 cities
            const selectedCities = type === 'top' ? sorted.slice(0, 5) : sorted.slice(-5).reverse();
            const title = `${type === 'top' ? 'Top' : 'Bottom'} 5 Cities`;

            // Construct HTML table for display
            let table = `<h3 class="font-semibold mb-1">${title}</h3>`;
            table += `<table class="min-w-full text-sm mb-4"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">City</th><th class="border border-black px-2 py-1">Sales</th></tr>`;
            selectedCities.forEach(([city, val]) => {
                table += `<tr><td class="border border-black px-2 py-1">${city}</td><td class="border border-black px-2 py-1">${val.toLocaleString()}</td></tr>`;
            });
            table += '</table>';

            addMessage('Bot', table);
        }

        // Function to display top or bottom 5 states by sales
        function showTopBottomStates(month, year, product, type = 'top') {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No state data found.');

            const stateSales = {}; // Aggregates sales per state
            filtered.forEach(r => {
                const state = r['Ship To State Text'] || 'Unknown';
                stateSales[state] = (stateSales[state] || 0) + (+r['Net Sales Qty'] || 0);
            });

            // Sort states by sales quantity
            const sorted = Object.entries(stateSales).sort((a, b) => b[1] - a[1]);
            // Get top 5 or bottom 5 states
            const selectedStates = type === 'top' ? sorted.slice(0, 5) : sorted.slice(-5).reverse();
            const title = `${type === 'top' ? 'Top' : 'Bottom'} 5 States`;

            // Construct HTML table for display
            let table = `<h3 class="font-semibold mb-1">${title}</h3>`;
            table += `<table class="min-w-full text-sm mb-4 border border-black border-collapse"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">State</th><th class="border border-black px-2 py-1">Sales</th></tr>`;
            selectedStates.forEach(([state, val]) => {
                table += `<tr><td class="border border-black px-2 py-1">${state}</td><td class="border border-black px-2 py-1">${val.toLocaleString()}</td></tr>`;
            });
            table += '</table>';

            addMessage('Bot', table);
        }

        // Function to handle comparison queries, determining if it's month-year or year-over-year
        function handleComparisonQuery(query, product) {
            // Regex to find month-year combinations (e.g., "Jan 2023")
            const monthYearMatches = [...query.matchAll(/([A-Za-z]+)[\s\-]?(20\d{2})/g)];
            // Regex to find standalone years (e.g., "2023")
            const yearMatches = [...query.matchAll(/\b(20\d{2})\b/g)];

            // If two valid month-year combinations are found
            if (monthYearMatches.length >= 2) {
                const [, m1, y1] = monthYearMatches[0];
                const [, m2, y2] = monthYearMatches[1];
                const month1 = monthMap[m1.toLowerCase()]; // Normalize month name
                const month2 = monthMap[m2.toLowerCase()];
                if (month1 && month2) { // Ensure both months were successfully mapped
                    return compareSales(month1, y1, month2, y2, product); // Call month-wise comparison
                }
            }

            // If at least two years are present
            if (yearMatches.length >= 2) {
                let [year1, year2] = [yearMatches[0][1], yearMatches[1][1]];
                if (year1 === year2) {
                    return addMessage('Bot', 'Please choose two different years to compare.'); // Prevent comparing same year
                }
                if (year2 < year1) [year1, year2] = [year2, year1]; // Ensure year1 is always earlier
                return compareSalesByYear(year1, year2, product); // Call year-wise comparison
            }

            // If the query format is unclear, provide guidance
            addMessage('Bot', `To compare, specify either:
‚Ä¢ Two full month‚Äëyears (e.g., "Compare Jan 2023 with Mar 2024"), or
‚Ä¢ Two years (e.g., "Compare 2023 with 2024").`);
        }

        // Function to compare sales between two specific month-year periods
        function compareSales(month1, year1, month2, year2, product) {
            // Helper to normalize month names (e.g., "January" to "Jan")
            const normalizeMonth = (m) => {
                const map = {
                    jan: "Jan", january: "Jan", feb: "Feb", february: "Feb",
                    mar: "Mar", march: "Mar", apr: "Apr", april: "Apr",
                    may: "May", jun: "Jun", june: "Jun", jul: "Jul", july: "Jul",
                    aug: "Aug", august: "Aug", sep: "Sep", sept: "Sep", september: "Sep",
                    oct: "Oct", october: "Oct", nov: "Nov", november: "Nov",
                    dec: "Dec", december: "Dec"
                };
                return m ? map[m.toLowerCase()] || m : null;
            };

            // Helper to get a sortable numeric value from month and year (for chronological ordering)
            const getSortableValue = (month, year) => {
                const monthOrder = {
                    Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6,
                    Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12
                };
                const m = month ? monthOrder[month] : 0; // Get month number, 0 if no month (for year-only comparisons)
                return parseInt(year) * 100 + m; // Combines year and month for a unique sortable number
            };

            const m1 = normalizeMonth(month1); // Normalized first month
            const m2 = normalizeMonth(month2); // Normalized second month

            const key1 = getSortableValue(m1, year1); // Sortable key for first period
            const key2 = getSortableValue(m2, year2); // Sortable key for second period

            let earlier = { month: m1, year: year1 }; // Assume first period is earlier
            let later = { month: m2, year: year2 }; // Assume second period is later

            if (key1 > key2) { // If assumption is wrong, swap periods
                [earlier, later] = [later, earlier];
            }

            // Get sales data for both periods using the filterData helper
            const sales1 = filterData(earlier.month, earlier.year, product).reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            const sales2 = filterData(later.month, later.year, product).reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);

            // Create display labels for the periods
            const label1 = earlier.month ? `${earlier.month} ${earlier.year}` : earlier.year;
            const label2 = later.month ? `${later.month} ${later.year}` : later.year;

            let percentChange = 'N/A'; // Initialize percentage change display
            let colorClass = ''; // Initialize color class for change indicator

            if (sales1 !== 0) { // Calculate percentage change only if initial sales are not zero
                const change = ((sales2 - sales1) / sales1) * 100;
                const formattedChange = change.toFixed(2) + '%';
                colorClass = change >= 0 ? 'text-green-600' : 'text-red-600'; // Green for positive, red for negative
                percentChange = `<span class="${colorClass}">${formattedChange}</span>`;
            }

            // Construct HTML table to display comparison results
            const table = `
        <table class="min-w-full text-sm">
          <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Period</th><th class="border border-black px-2 py-1">Sales</th></tr>
          <tr><td class="border border-black px-2 py-1">${label1}</td><td class="border border-black px-2 py-1">${sales1.toLocaleString()}</td></tr>
          <tr><td class="border border-black px-2 py-1">${label2}</td><td class="border border-black px-2 py-1">${sales2.toLocaleString()}</td></tr>
        </table>
        <div class="mt-2 text-sm text-gray-700">Percentage Change: <strong>${percentChange}</strong></div>
    `;

            addMessage('Bot', `<h3 class="font-semibold mb-1">Month-wise Sales Comparison</h3>` + table); // Display message
        }

        // Function to compare total sales between two specified years
        function compareSalesByYear(year1, year2, product) {
            // Get total sales for the first year (month is null for annual total)
            const sales1 = filterData(null, year1, product).reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            // Get total sales for the second year
            const sales2 = filterData(null, year2, product).reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);

            let percentChange = 'N/A'; // Initialize percentage change display
            let colorClass = ''; // Initialize color class for change indicator

            if (sales1 !== 0) { // Calculate percentage change only if initial sales are not zero
                const change = ((sales2 - sales1) / sales1) * 100;
                const formattedChange = change.toFixed(2) + '%';
                colorClass = change >= 0 ? 'text-green-600' : 'text-red-600'; // Green for positive, red for negative
                percentChange = `<span class="${colorClass}">${formattedChange}</span>`;
            }

            // Construct HTML table to display annual comparison results
            const table = `
    <table class="min-w-full text-sm">
      <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Year</th><th class="border border-black px-2 py-1">Sales</th></tr>
      <tr><td class="border border-black px-2 py-1">${year1}</td><td class="border border-black px-2 py-1">${sales1.toLocaleString()}</td></tr>
      <tr><td class="border border-black px-2 py-1">${year2}</td><td class="border border-black px-2 py-1">${sales2.toLocaleString()}</td></tr>
    </table>
    <div class="mt-2 text-sm text-gray-700">Percentage Change: <strong>${percentChange}</strong></div>
  `;

            addMessage('Bot', `<h3 class="font-semibold mb-1">Year-wise Sales Comparison</h3>` + table); // Display message

        }

        // Function to compare sales between two specific cities
        function compareCities(city1, city2, month, year, product) {
            const filtered = filterData(month, year, product);
            let total1 = 0, total2 = 0; // Initialize total sales for each city

            filtered.forEach(r => {
                const city = (r['Ship To City'] || '').toLowerCase(); // Get city name and convert to lowercase
                const qty = +r['Net Sales Qty'] || 0; // Get sales quantity

                if (city.includes(city1.toLowerCase())) total1 += qty; // Aggregate sales for city1
                if (city.includes(city2.toLowerCase())) total2 += qty; // Aggregate sales for city2
            });

            // Construct HTML table to display city comparison results
            const table = `
    <table class="min-w-full text-sm">
        <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">City</th><th class="border border-black px-2 py-1">Sales</th></tr>
        <tr><td class="border border-black px-2 py-1">${city1}</td><td class="border border-black px-2 py-1">${total1.toLocaleString()}</td></tr>
        <tr><td class="border border-black px-2 py-1">${city2}</td><td class="border border-black px-2 py-1">${total2.toLocaleString()}</td></tr>
    </table>
    `;

            addMessage('Bot', `<h3 class="font-semibold mb-1">City-wise Sales Comparison</h3>` + table); // Display message

        }

        // Function to compare sales between two specific states
        function compareStates(state1, state2, month, year, product) {
            const filtered = filterData(month, year, product);
            let total1 = 0, total2 = 0; // Initialize total sales for each state

            filtered.forEach(r => {
                const state = (r['Ship To State Text'] || '').toLowerCase(); // Get state name and convert to lowercase
                const qty = +r['Net Sales Qty'] || 0; // Get sales quantity

                if (state.includes(state1.toLowerCase())) total1 += qty; // Aggregate sales for state1
                if (state.includes(state2.toLowerCase())) total2 += qty; // Aggregate sales for state2
            });

            // Construct HTML table to display state comparison results
            const table = `
    <table class="min-w-full text-sm">
        <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">State</th><th class="border border-black px-2 py-1">Sales</th></tr>
        <tr><td class="border border-black px-2 py-1">${state1}</td><td class="border border-black px-2 py-1">${total1.toLocaleString()}</td></tr>
        <tr><td class="border border-black px-2 py-1">${state2}</td><td class="border border-black px-2 py-1">${total2.toLocaleString()}</td></tr>
    </table>
    `;

            addMessage('Bot', `<h3 class="font-semibold mb-1">State-wise Sales Comparison</h3>` + table); // Display message
        }


        // --- General Sales Functions (Ordered as per <optgroup label="General Sales">) ---

        // Function to display total sales quantity based on current filters
        function showSalesForSelection(month, year, product) {
            const filtered = filterData(month, year, product); // Filter data based on selected criteria
            const total = filtered.reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0); // Calculate sum of 'Net Sales Qty'
            addMessage('Bot', filtered.length // Check if any data was found
                ? `Total Net Sales Qty: ${total.toLocaleString()} MT` // Display total sales
                : 'No matching data found.'); // Message if no data matches filters
        }

        // Function to display monthly sales for a given year
        function showMonthlySales(year, product) {
            const filtered = filterData(null, year, product); // Filter data for the specific year (month is null for all months)
            if (!filtered.length) return addMessage('Bot', `No data found for ${year}.`); // If no data, display message

            const monthlyTotals = {}; // Object to store aggregated sales per month
            filtered.forEach(r => {
                const month = r.Month_Name; // Get month name from record
                monthlyTotals[month] = (monthlyTotals[month] || 0) + (+r['Net Sales Qty'] || 0); // Aggregate sales
            });

            // Define a custom order for months to ensure correct sorting (Jan, Feb, ...)
            const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            // Sort the monthly totals according to the defined month order
            const sorted = Object.entries(monthlyTotals).sort((a, b) =>
                monthOrder.indexOf(a[0]) - monthOrder.indexOf(b[0])
            );

            // Construct HTML table to display monthly sales
            let table = `<table class="min-w-full text-sm"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Month</th><th class="border border-black px-2 py-1">Sales Qty</th></tr>`;
            sorted.forEach(([month, qty]) => {
                table += `<tr><td class="border border-black px-2 py-1">${month}</td><td class="border border-black px-2 py-1">${qty.toLocaleString()}</td></tr>`;
            });
            table += `</table>`;

            addMessage('Bot', `<h3 class="font-semibold mb-1">Monthly Sales for ${year}</h3>` + table); // Display message

        }

        // Function to display quarter-wise sales
        function showQuarterlySales(month, year, product) {
            const filtered = filterData(month, year, product); // Filter data based on current selections
            if (!filtered.length) return addMessage('Bot', 'No data found.'); // If no data, display message

            const quarterSales = {}; // Object to aggregate sales per quarter
            filtered.forEach(r => {
                const quarter = r['Qtr No'] || 'Q?'; // Get quarter number (or 'Q?' if missing)
                quarterSales[quarter] = (quarterSales[quarter] || 0) + (+r['Net Sales Qty'] || 0); // Aggregate sales
            });

            // Sort quarters numerically (e.g., Q1, Q2, Q3, Q4)
            const sorted = Object.entries(quarterSales).sort((a, b) => a[0] - b[0]);

            // Construct HTML table to display quarter-wise sales
            let table = `<h3 class="font-semibold mb-1">Quarter-wise Sales</h3>`;
            table += `<table class="min-w-full text-sm mb-4"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Quarter</th><th class="border border-black px-2 py-1">Sales</th></tr>`;
            sorted.forEach(([qtr, val]) => {
                table += `<tr><td class="border border-black px-2 py-1">Q${qtr}</td><td class="border border-black px-2 py-1">${val.toLocaleString()}</td></tr>`;
            });
            table += '</table>';

            addMessage('Bot', table); // Display message
        }


        // --- Detailed Geographic Sales Functions (Ordered as per <optgroup label="Detailed Geographic Sales">) ---

        // Function to display sales aggregated by city or state
        function showLocationWiseSales(type, month, year, product) {
            // Determine the key for aggregation ('Ship To State Text' or 'Ship To City')
            const key = type === 'state' ? 'Ship To State Text' : 'Ship To City';
            const filtered = filterData(month, year, product); // Filter data
            const locSales = {}; // Object to aggregate sales by location

            filtered.forEach(r => {
                const loc = r[key] || 'Unknown'; // Get location name
                locSales[loc] = (locSales[loc] || 0) + (+r['Net Sales Qty'] || 0); // Aggregate sales
            });

            // Sort locations by sales quantity in descending order
            const sorted = Object.entries(locSales).sort((a, b) => b[1] - a[1]);
            if (!sorted.length) return addMessage('Bot', `No ${type}-wise data found.`); // If no data, display message

            // Construct HTML table for display
            let table = `<table class="min-w-full text-sm"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">${type.charAt(0).toUpperCase() + type.slice(1)}</th><th class="border border-black px-2 py-1">Sales</th></tr>`;
            sorted.forEach(([loc, qty]) => {
                table += `<tr><td class="border border-black px-2 py-1">${loc}</td><td class="border border-black px-2 py-1">${qty.toLocaleString()}</td></tr>`;
            });
            table += '</table>';
            // Display message with appropriate title (e.g., "City-wise Sales")
            addMessage('Bot', `<h3 class="font-semibold mb-1">${type.charAt(0).toUpperCase() + type.slice(1)}-wise Sales</h3>` + table);

        }

        // Function to display sales for a specific city
        function showSpecificLocationSales(queryCity, month, year, product) {
            const filtered = filterData(month, year, product); // Filter data
            const lowerQuery = queryCity.toLowerCase(); // Convert query city to lowercase for case-insensitive comparison
            // Check if any record matches the queried city (case-insensitive)
            const match = filtered.find(r => (r['Ship To City'] || '').toLowerCase() === lowerQuery);
            if (!match) return addMessage('Bot', `No sales data found for "${queryCity}".`); // If no match, display message
            const city = match['Ship To City']; // Get the actual city name from data (for correct casing if needed)
            // Calculate total sales for the specific city
            const total = filtered
                .filter(r => (r['Ship To City'] || '').toLowerCase() === lowerQuery)
                .reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            addMessage('Bot', `Total sales in ${city}: ${total.toLocaleString()} MT`); // Display total sales
        }

        // Function to display sales for a specific state
        function showSpecificStateSales(queryState, month, year, product) {
            const filtered = filterData(month, year, product); // Filter data
            const lowerQuery = queryState.toLowerCase(); // Convert query state to lowercase
            // Check if any record matches the queried state (case-insensitive)
            const match = filtered.find(r => (r['Ship To State Text'] || '').toLowerCase() === lowerQuery);
            if (!match) return addMessage('Bot', `No sales data found for "${queryState}".`); // If no match, display message
            const state = match['Ship To State Text']; // Get the actual state name
            // Calculate total sales for the specific state
            const total = filtered
                .filter(r => (r['Ship To State Text'] || '').toLowerCase() === lowerQuery)
                .reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            addMessage('Bot', `Total sales in ${state}: ${total.toLocaleString()} MT`); // Display total sales
        }

        // Function to show sales broken down by sales district and then by state within each district
        function showSalesByDistrictAndState(month, year, product) {
            const filtered = filterData(month, year, product);
            const districtData = {}; // Stores sales aggregated by district, and then by state within each district

            filtered.forEach(r => {
                const district = r['Sales District'] || 'Unknown';
                const state = r['Ship To State Text'] || 'Unknown';
                const qty = +r['Net Sales Qty'] || 0;

                if (!districtData[district]) {
                    districtData[district] = { total: 0, states: {} }; // Initialize for new district
                }

                districtData[district].total += qty; // Aggregate total sales for the district
                // Aggregate sales for the specific state within that district
                districtData[district].states[state] = (districtData[district].states[state] || 0) + qty;
            });

            // Sort districts by their total sales in descending order
            const sortedDistricts = Object.entries(districtData).sort((a, b) => b[1].total - a[1].total);

            let msg = `<h3 class="font-semibold mb-1">Sales District-wise Breakdown (with States)</h3>`;

            // Iterate through sorted districts to build the display message
            sortedDistricts.forEach(([district, data]) => {
                // Display district name and its total sales prominently
                msg += `<div class="mb-3"><strong>${district}</strong> - <span style="font-weight: bold; background-color: #facc15; padding: 2px 6px; border-radius: 4px;"> Total Sales: ${data.total.toLocaleString()} MT</span>`;
                // Create a nested table for states within each district
                msg += `<table class="min-w-full text-sm mt-1">
                <tr style="background-color: #f3f4f6;">
                    <th class="border border-black px-2 py-1">State</th>
                    <th class="border border-black px-2 py-1">Sales</th>
                </tr>`;
                // Sort states within the current district by sales in descending order
                const sortedStates = Object.entries(data.states).sort((a, b) => b[1] - a[1]);
                sortedStates.forEach(([state, qty]) => {
                    msg += `<tr>
                        <td class="border border-black px-2 py-1">${state}</td>
                        <td class="border border-black px-2 py-1">${qty.toLocaleString()}</td>
                    </tr>`;
                });
                msg += `</table></div>`;
            });

            addMessage('Bot', msg); // Display the detailed breakdown
        }


        // --- Focus Areas Functions (Ordered as per <optgroup label="Focus Areas">) ---

        // Function to compare sales in Maharashtra and Karnataka (assumed focus states)
        function compareMaharashtraAndKarnataka(month, year, product) {
            const filtered = filterData(month, year, product);
            let totalMH = 0, totalKA = 0; // Initialize sales for each state

            filtered.forEach(r => {
                const state = (r['Ship To State Text'] || '').toLowerCase(); // Get state and convert to lowercase
                const qty = +r['Net Sales Qty'] || 0; // Get sales quantity

                if (state.includes('maharashtra')) totalMH += qty; // Aggregate sales for Maharashtra
                if (state.includes('karnataka')) totalKA += qty; // Aggregate sales for Karnataka
            });

            // Construct a simple message showing sales for both states
            const msg = `
        Maharashtra: ${totalMH.toLocaleString()} MT<br>
        Karnataka: ${totalKA.toLocaleString()} MT
    `;
            addMessage('Bot', `<h3 class="font-semibold mb-1">Focus States Comparison</h3><div>${msg}</div>`); // Display message

        }

        // Function to show SKU-wise sales breakdown for assumed "focus states" (Maharashtra & Karnataka)
        function showProductSalesForFocusStates(month, year, product) {
            const filtered = filterData(month, year, product);
            const mhProducts = {}; // Stores product sales for Maharashtra
            const kaProducts = {}; // Stores product sales for Karnataka

            filtered.forEach(r => {
                const state = (r['Ship To State Text'] || '').toLowerCase(); // Get state and convert to lowercase
                const desc = r['Product Description'] || 'Unknown'; // Get product description (SKU)
                const qty = +r['Net Sales Qty'] || 0; // Get sales quantity

                if (state.includes('maharashtra')) {
                    mhProducts[desc] = (mhProducts[desc] || 0) + qty; // Aggregate for Maharashtra
                } else if (state.includes('karnataka')) {
                    kaProducts[desc] = (kaProducts[desc] || 0) + qty; // Aggregate for Karnataka
                }
            });

            // Get all unique product names across both states
            const allProducts = new Set([...Object.keys(mhProducts), ...Object.keys(kaProducts)]);
            // Sort products by their combined sales in both states (descending)
            const sortedProducts = Array.from(allProducts).sort((a, b) => {
                const totalA = (mhProducts[a] || 0) + (kaProducts[a] || 0);
                const totalB = (kaProducts[b] || 0) + (kaProducts[b] || 0);
                return totalB - totalA;
            });

            // Construct HTML table for displaying SKU-wise sales in focus states
            let table = `
    <h3 class="font-semibold mb-1">SKU-wise Sales in Focus States</h3>
    <table class="min-w-full text-sm mb-4 border border-black border-collapse">
        <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">Product Description</th>
            <th class="border border-black px-2 py-1">Maharashtra</th>
            <th class="border border-black px-2 py-1">Karnataka</th>
        </tr>
    `;

            // Populate table rows with sales data for each product in both states
            sortedProducts.forEach(desc => {
                const mhQty = mhProducts[desc] || 0; // Sales in Maharashtra for this product
                const kaQty = kaProducts[desc] || 0; // Sales in Karnataka for this product
                table += `
        <tr>
            <td class="border border-black px-2 py-1">${desc}</td>
            <td class="border border-black px-2 py-1">${mhQty.toLocaleString()}</td>
            <td class="border border-black px-2 py-1">${kaQty.toLocaleString()}</td>
        </tr>`;
            });

            table += '</table>';
            addMessage('Bot', table); // Display the table
        }


        // --- SKU/Product-Based Sales Functions (Ordered as per <optgroup label="SKU/Product-Based Sales">) ---

        // Function to display total sales aggregated by SKU (Product Description)
        function showSkuWiseSales(month, year, product) {
            const filtered = filterData(month, year, product); // Filter data
            const skuSales = {}; // Object to aggregate sales per SKU

            filtered.forEach(r => {
                const sku = r['Product Description'] || 'Unknown'; // Get SKU description
                const qty = +r['Net Sales Qty'] || 0; // Get sales quantity
                skuSales[sku] = (skuSales[sku] || 0) + qty; // Aggregate sales for each SKU
            });

            // Sort SKUs by their total sales in descending order
            const sortedSkus = Object.entries(skuSales)
                .sort((a, b) => b[1] - a[1]);

            // Construct HTML table to display SKU-wise sales
            let table = `
    <h3 class="font-semibold mb-1">SKU-wise Sales</h3>
    <table class="min-w-full text-sm mb-4 border border-black border-collapse">
        <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">Product Description (SKU)</th>
            <th class="border border-black px-2 py-1">Total Sales</th>
        </tr>
    `;

            // Populate table rows with SKU and its total sales
            sortedSkus.forEach(([sku, qty]) => {
                table += `
        <tr>
            <td class="border border-black px-2 py-1">${sku}</td>
            <td class="border border-black px-2 py-1">${qty.toLocaleString()}</td>
        </tr>`;
            });

            table += '</table>';
            addMessage('Bot', table); // Display the table
        }

        // Function to display sales broken down by state, and then by SKU within each state
        function showStateWiseProductSales(month, year, product) {
            const filtered = filterData(month, year, product);
            const stateData = {}; // Stores sales aggregated by state, and then by SKU within each state

            filtered.forEach(r => {
                const state = r['Ship To State Text'] || 'Unknown'; // Get state name
                const sku = r['Product Description'] || 'Unknown'; // Get SKU description
                const qty = +r['Net Sales Qty'] || 0; // Get sales quantity

                if (!stateData[state]) {
                    stateData[state] = { total: 0, skus: {} }; // Initialize for new state
                }

                stateData[state].total += qty; // Aggregate total sales for the state
                // Aggregate sales for the specific SKU within that state
                stateData[state].skus[sku] = (stateData[state].skus[sku] || 0) + qty;
            });

            // Sort states by their total sales in descending order
            const sortedStates = Object.entries(stateData).sort((a, b) => b[1].total - a[1].total);

            let msg = `<h3 class="font-semibold mb-1">State-wise Sales with Product Breakdown</h3>`;

            // Iterate through sorted states to build the display message
            sortedStates.forEach(([state, data]) => {
                // Display state name and its total sales prominently
                msg += `<div class="mt-4 mb-3"><strong>${state}</strong> - <span style="font-weight: bold; background-color: #facc15; padding: 2px 6px; border-radius: 4px;">Total Sales: ${data.total.toLocaleString()} MT</span></div>`;
                // Create a nested table for SKUs within each state
                msg += `<table class="min-w-full text-sm mt-1">
                <tr style="background-color: #f3f4f6;">
                    <th class="border border-black px-2 py-1">Product Description</th>
                    <th class="border border-black px-2 py-1">Sales Qty</th>
                </tr>`;
                // Sort SKUs within the current state by sales in descending order
                const sortedSkus = Object.entries(data.skus).sort((a, b) => b[1] - a[1]);
                sortedSkus.forEach(([sku, qty]) => {
                    msg += `<tr>
                        <td class="border border-black px-2 py-1">${sku}</td>
                        <td class="border border-black px-2 py-1">${qty.toLocaleString()}</td>
                    </tr>`;
                });
                msg += `</table></div>`;
            });

            addMessage('Bot', msg); // Display the detailed breakdown
        }


        // --- Plant Sales Functions (Ordered as per <optgroup label="Plant Sales">) ---

        // Function to display sales performance aggregated by plant
        function showPlantPerformance(month, year, product) {
            const filtered = filterData(month, year, product); // Filter data
            if (!filtered.length) return addMessage('Bot', 'No plant data found for the selected filters.'); // If no data, display message

            const plantSales = {}; // Object to aggregate sales per plant

            filtered.forEach(r => {
                const plant = r['Plant_Name']; // Get plant name
                const qty = +r['Net Sales Qty'] || 0; // Get sales quantity

                if (!plant || plant.trim() === '') return; // Skip if plant name is empty or missing

                const cleanPlant = plant.trim(); // Trim whitespace from plant name
                plantSales[cleanPlant] = (plantSales[cleanPlant] || 0) + qty; // Aggregate sales for each plant
            });

            // Sort plants alphabetically by name for consistent display
            const allPlants = Object.entries(plantSales)
                .sort((a, b) => a[0].localeCompare(b[0]));

            if (allPlants.length === 0) {
                return addMessage('Bot', 'No valid plant names with sales found.'); // If no valid plants, display message
            }

            // Construct title including selected filters for context
            let title = `Plant-wise Sales (${[
                month ? 'Month: ' + month : '',
                year ? 'Year: ' + year : '',
                product ? 'Product: ' + product : ''
            ].filter(Boolean).join(', ')})`; // Join non-empty filter parts

            // Construct HTML table for plant-wise sales
            let table = `<h3 class="font-semibold mb-1">${title}</h3>`;
            table += `<table class="min-w-full text-sm mb-4 border border-black border-collapse">
              <tr style="background-color: #f3f4f6;">
                <th class="border border-black px-2 py-1">Plant Name</th>
                <th class="border border-black px-2 py-1">Net Sales Qty</th>
              </tr>`;
            allPlants.forEach(([plant, qty]) => {
                table += `<tr><td class="border border-black px-2 py-1">${plant}</td><td class="border border-black px-2 py-1">${qty.toLocaleString()}</td></tr>`;
            });
            table += `</table>`;

            addMessage('Bot', table); // Display the table

        }

        // Main handler for user requests triggered by "Ask the Bot" button or Enter key
        document.getElementById('sendBtn').addEventListener('click', handleUserRequest);
        document.addEventListener('keydown', function (e) {
            // Check if Enter key is pressed and a dropdown is currently focused
            const isDropdownFocused = ['querySelect', 'yearSelect', 'monthSelect', 'productSelect'].includes(document.activeElement.id);
            if (e.key === 'Enter' && isDropdownFocused) {
                handleUserRequest(); // Trigger the request handler
            }
        });

        // The core function that processes the selected query and filters
        function handleUserRequest() {
            const query = document.getElementById('querySelect').value; // Get the selected query value
            const month = document.getElementById('monthSelect').value; // Get the selected month filter
            const year = document.getElementById('yearSelect').value; // Get the selected year filter
            const product = document.getElementById('productSelect').value; // Get the selected product filter

            let handled = false; // Flag to check if a query was successfully handled

            // Use a switch statement to call the appropriate function based on the selected query
            switch (query) {
                // --- Insights Queries ---
                case 'nonfocusplants': showPlantSalesToNonFocusStates(month, year, product); handled = true; break;
                case 'avg': showAverageSales(month, year, product); handled = true; break;
                case 'top5customers': showTopBottomCustomers(month, year, product, 'top'); handled = true; break;
                case 'bottom5customers': showTopBottomCustomers(month, year, product, 'bottom'); handled = true; break;
                case 'topcustomersstate': showTopCustomersPerState(month, year, product); handled = true; break;
                case 'topcustomerscity': showTopCustomersPerCity(month, year, product); handled = true; break;
                case 'comparecustomersales':
                    // Open a modal to get required inputs for customer comparison
                    const customerNames = [...new Set(salesData.map(r => r['Customer Name']).filter(Boolean))].sort();
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const years = [...new Set(salesData.map(r => r['Year']).filter(Boolean))].sort((a, b) => b - a);

                    openModal('Compare Customer Sales', [
                        { id: 'customerName', placeholder: 'Select Customer', type: 'select', options: customerNames },
                        { id: 'month1', placeholder: 'Select First Month', type: 'select', options: months },
                        { id: 'year1', placeholder: 'Select First Year', type: 'select', options: years },
                        { id: 'month2', placeholder: 'Select Second Month', type: 'select', options: months },
                        { id: 'year2', placeholder: 'Select Second Year', type: 'select', options: years }
                    ], (customer, p1, p2) => {
                        // Callback from modal passes selected customer and periods to comparison function
                        compareCustomerSales(customer, p1, p2, product);
                    });
                    handled = true;
                    break;
                case 'top5cities': showTopBottomCities(month, year, product, 'top'); handled = true; break;
                case 'bottom5cities': showTopBottomCities(month, year, product, 'bottom'); handled = true; break;
                case 'top5states': showTopBottomStates(month, year, product, 'top'); handled = true; break;
                case 'bottom5states': showTopBottomStates(month, year, product, 'bottom'); handled = true; break;
                case 'compare':
                    // Open a modal to get periods for comparison (month-year or year-only)
                    const monthsList = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const yearsList = [...new Set(salesData.map(r => r['Year']).filter(Boolean))].sort((a, b) => b - a);
                    openModal('Compare Two Periods', [
                        { id: 'month1', placeholder: 'Select First Month (Optional)', type: 'select', options: monthsList },
                        { id: 'year1', placeholder: 'Select First Year', type: 'select', options: yearsList },
                        { id: 'month2', placeholder: 'Select Second Month (Optional)', type: 'select', options: monthsList },
                        { id: 'year2', placeholder: 'Select Second Year', type: 'select', options: yearsList }
                    ], (m1, y1, m2, y2) => {
                        // Construct a dummy query string from modal inputs and pass to handleComparisonQuery
                        const query = `compare ${m1 ? m1 + ' ' : ''}${y1} and ${m2 ? m2 + ' ' : ''}${y2}`;
                        handleComparisonQuery(query, product);
                    });
                    handled = true;
                    break;
                case 'comparecities':
                    // Open a modal to select two cities for comparison
                    const cities = [...new Set(salesData.map(r => r['Ship To City']).filter(Boolean))].sort();
                    openModal('Compare Two Cities', [
                        { id: 'city1', placeholder: 'Select First City', type: 'select', options: cities },
                        { id: 'city2', placeholder: 'Select Second City', type: 'select', options: cities }
                    ], (c1, c2) => {
                        compareCities(c1, c2, month, year, product);
                    });
                    handled = true;
                    break;
                case 'comparestates':
                    // Open a modal to select two states for comparison
                    const states = [...new Set(salesData.map(r => r['Ship To State Text']).filter(Boolean))].sort();
                    openModal('Compare Two States', [
                        { id: 'state1', placeholder: 'Select First State', type: 'select', options: states },
                        { id: 'state2', placeholder: 'Select Second State', type: 'select', options: states }
                    ], (s1, s2) => {
                        compareStates(s1, s2, month, year, product);
                    });
                    handled = true;
                    break;

                // --- General Sales Queries ---
                case 'sales': showSalesForSelection(month, year, product); handled = true; break;
                case 'monthly': showMonthlySales(year, product); handled = true; break;
                case 'quarterly': showQuarterlySales(month, year, product); handled = true; break;

                // --- Detailed Geographic Sales Queries ---
                case 'citywise': showLocationWiseSales('city', month, year, product); handled = true; break;
                case 'statewise': showLocationWiseSales('state', month, year, product); handled = true; break;
                case 'specificcity':
                    // Open a modal to select a specific city
                    const cityOptions = [...new Set(salesData.map(r => r['Ship To City']).filter(Boolean))].sort();
                    openModal('Sales in Specific City', [
                        { id: 'cityName', placeholder: 'Select City', type: 'select', options: cityOptions }
                    ], (city) => {
                        showSpecificLocationSales(city, month, year, product);
                    });
                    handled = true;
                    break;
                case 'specificstate':
                    // Open a modal to select a specific state
                    const stateOptions = [...new Set(salesData.map(r => r['Ship To State Text']).filter(Boolean))].sort();
                    openModal('Sales in Specific State', [
                        { id: 'stateName', placeholder: 'Select State', type: 'select', options: stateOptions }
                    ], (state) => {
                        showSpecificStateSales(state, month, year, product);
                    });
                    handled = true;
                    break;
                case 'districtbreakdown': showSalesByDistrictAndState(month, year, product); handled = true; break;

                // --- Focus Areas Queries ---
                case 'focusstates': compareMaharashtraAndKarnataka(month, year, product); handled = true; break;
                case 'focusproductstates': showProductSalesForFocusStates(month, year, product); handled = true; break;

                // --- SKU/Product-Based Sales Queries ---
                case 'skusales': showSkuWiseSales(month, year, product); handled = true; break;
                case 'stateproductbreakdown': showStateWiseProductSales(month, year, product); handled = true; break;

                // --- Plant Sales Queries ---
                case 'plant': showPlantPerformance(month, year, product); handled = true; break;

                default:
                    // Default message if no specific query is selected or recognized
                    addMessage('Bot', "Please select a query from the drop-down.");
                    handled = true; // Mark as handled to prevent further processing
                    break;
            }

            // Fallback message if no query was selected from the dropdown
            if (!handled && query === "") {
                addMessage('Bot', "Please select a query from the drop-down.");
            }
        }
    </script>
    <div id="inputModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md text-black">
            <h2 id="modalTitle" class="text-xl font-semibold mb-4 text-gray-800">Modal Title</h2>
            <div id="modalFields" class="space-y-3"></div>
            <div class="flex justify-end space-x-2 mt-5">
                <button id="modalCancelBtn"
                    class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
                <button id="modalSubmitBtn"
                    class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Submit</button>
            </div>
        </div>
    </div>

</body>

</html>