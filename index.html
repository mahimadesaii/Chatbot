<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Sales Data Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for reading Excel/CSV files -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-blue-900 flex flex-col items-center min-h-screen p-6 text-white" style="padding-top: 120px;">

    <!-- White background strip -->
    <div class="w-full bg-white py-4 px-6 fixed top-0 left-0 z-50">
        <div class="flex items-center gap-3 justify-start w-full max-w-screen">
            <img src="logo.jpeg" alt="Company Logo" class="w-28 h-18 rounded-md" />

        </div>
    </div>

    <!-- Title BELOW white bar -->
    <div class="w-full bg-blue-900 text-center fixed top-20 z-20 py-4">
        <h1 class="text-3xl font-bold text-white tracking-wide font-serif">
            BotNova
        </h1>
    </div>

    <!-- Unified Horizontal Toolbar -->
    <div class="w-full flex flex-wrap items-center justify-center gap-4 mt-10 px-6">

        <!-- File Upload Button -->
        <label for="fileInput"
            class="w-25 h-10 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-semibold transition text-center cursor-pointer flex justify-center items-center">
            Choose file
        </label>

        <!-- File Name Display -->
        <div id="fileNameDisplay"
            class="w-40 h-10 flex items-center px-3 bg-white border border-gray-300 rounded text-sm text-black">
            No file chosen
        </div>

        <!-- Hidden File Input -->
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="hidden" />

        <!-- Filter: Year -->
        <select id="yearSelect" class="w-40 p-2 rounded bg-white text-black border border-gray-300 focus:outline-none">
            <option value="">Year</option>
        </select>

        <!-- Filter: Month -->
        <select id="monthSelect" class="w-40 p-2 rounded bg-white text-black border border-gray-300 focus:outline-none">
            <option value="">Month</option>
        </select>

        <!-- Filter: Product -->
        <select id="productSelect"
            class="w-40 p-2 rounded bg-white text-black border border-gray-300 focus:outline-none">
            <option value="">Product</option>
        </select>

        <!-- Query Selection -->
        <select id="querySelect" class="w-60 p-2 rounded bg-white text-black border border-gray-300 focus:outline-none">
            <option value="">Select a Query</option>

            <optgroup label="Insights">
                <option value="nonfocusplants">Plant Sales to Non-Focus States</option>
                <option value="avg">Average Sales per Customer</option>
                <option value="top5customers">Top 5 Customers</option>
                <option value="bottom5customers">Bottom 5 Customers</option>
                <option value="topcustomersstate">Top Customers per State</option>
                <option value="topcustomerscity">Top Customers per City</option>
                <option value="comparecustomersales">Compare Customer Sales</option>
                <option value="top5cities">Top 5 Cities by Sales</option>
                <option value="bottom5cities">Bottom 5 Cities by Sales</option>
                <option value="top5states">Top 5 States by Sales</option>
                <option value="bottom5states">Bottom 5 States by Sales</option>
                <option value="compare">Compare Two Periods</option>
                <option value="comparecities">Compare Sales Between Two Cities</option>
                <option value="comparestates">Compare Sales Between Two States</option>
            </optgroup>

            <optgroup label="General Sales">
                <option value="sales">Total Sales</option>
                <option value="monthly">Monthly Sales</option>
                <option value="quarterly">Quarter-wise Sales</option>
            </optgroup>

            <optgroup label="Detailed Geographic Sales">
                <option value="citywise">City-wise Sales (Ship To)</option>
                <option value="statewise">State-wise Sales (Ship To)</option>
                <option value="specificcity">Sales in a Specific City (Ship To)</option>
                <option value="specificstate">Sales in a Specific State (Ship To)</option>
                <option value="districtbreakdown">Region-wise Breakdown</option>
            </optgroup>

            <optgroup label="Focus Areas">
                <option value="focusstates">Focus States</option>
                <option value="focusproductstates">Focus States (SKU-wise Sales)</option>
            </optgroup>

            <optgroup label="SKU/Product-Based Sales">
                <option value="skusales">SKU-wise Sales</option>
                <option value="stateproductbreakdown">State SKU-wise Sales</option>
            </optgroup>

            <optgroup label="Plant Sales">
                <option value="plant">Plant-wise Sales</option>
            </optgroup>
        </select>

        <!-- Ask the Bot Button -->
        <button id="sendBtn"
            class="w-25 h-10 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-semibold transition">
            Ask the Bot
        </button>

        <!-- User Manual Button -->
        <button
            onclick="window.open('https://jsw-my.sharepoint.com/:w:/g/personal/satyen_shah_jsw_in/EcxFXo5GYrlKhaOwr_ESqPcB7dS4q0KvslHtmDN0XyZDJg?e=9gOnRR', '_blank')"
            class="fixed bottom-20 right-4 bg-gray-600 text-white px-3 py-2 rounded-full shadow hover:bg-gray-700 z-50"
            title="User Manual">
            üìù
        </button>

        <!-- Sample Data Button -->
        <button
            onclick="window.open('https://jsw-my.sharepoint.com/:x:/g/personal/satyen_shah_jsw_in/EWcRCojMPkFKiMfB2eLOadEBmjBkDNjSMnJRCo_WrJh5wA?e=qG4Sgn', '_blank')"
            class="fixed bottom-6 right-4 bg-gray-600 text-white px-3 py-2 rounded-full shadow hover:bg-gray-700 z-50"
            title="Sample Data">
            üìä
        </button>

        <!-- Hidden User Input -->
        <input id="userInput" class="hidden" placeholder="Ask me about the sales data‚Ä¶" />
    </div>


    <!-- Bigger Chat Window -->
    <div id="chatWindow"
        class="w-[1250px] mt-8 h-[450px] overflow-y-auto bg-white border border-gray-200 shadow rounded p-5 mb-4 text-base text-black">
        <!-- Chat messages appear here -->
    </div>
    </div>

    <script>
        constsession = {
            customerCompare: {},
            awaitingCustomerName: false,
            awaitingCustomerPeriod: false
        };
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        fileInput.addEventListener('change', function () {
            const fileName = this.files.length > 0 ? this.files[0].name : "No file chosen";
            fileNameDisplay.textContent = fileName;
        });

        let salesData = []; // Holds the loaded sales records

        // Handle file input change event
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                salesData = XLSX.utils.sheet_to_json(sheet);

                // Populate filter dropdowns
                const years = new Set();
                const months = new Set();
                const products = new Set();

                salesData.forEach(r => {
                    if (r.Year) years.add(r.Year);
                    if (r.Month_Name) months.add(r.Month_Name);
                    if (r['Product  Hierarchy - Product Variant']) {
                        products.add(r['Product  Hierarchy - Product Variant']);
                    }
                });
                const sortedYears = Array.from(years).sort((a, b) => b - a);
                populateSelect('yearSelect', years);
                if (sortedYears.length > 0) {
                    document.getElementById('yearSelect').value = sortedYears[0];
                }
                populateSelect('monthSelect', months);
                populateSelect('productSelect', products);

                addMessage('Bot', 'File loaded! You can now use filters and ask questions.');
            };
            reader.readAsArrayBuffer(file);
        });

        // Helper: Populate a select element with sorted values
        function populateSelect(id, setValues) {
            const select = document.getElementById(id);
            const placeholder = select.options[0].text;
            select.innerHTML = `<option value="">${placeholder}</option>`;
            Array.from(setValues).sort().forEach(value => {
                select.innerHTML += `<option value="${value}">${value}</option>`;
            });
        }

        function handleUserRequest() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;
            const product = document.getElementById('productSelect').value;
            const querySelectValue = document.getElementById('querySelect').value;
            const queryInput = document.getElementById('userInput');
            let query = queryInput.value.trim().toLowerCase() || querySelectValue;

            addMessage('You', (query || '[Selection]') +
                (year ? ' | Year: ' + year : '') +
                (month ? ' | Month: ' + month : '') +
                (product ? ' | Product: ' + product : ''));

            let handled = false;

            if (/^(total\s*)?sales$/i.test(query)) {
                showSalesForSelection(month, year, product);
                handled = true;
            } else if (/top\s*5.*customer/i.test(query)) {
                showTopBottomCustomers(month, year, product, 'top');
                handled = true;
            } else if (/bottom\s*5.*customer/i.test(query)) {
                showTopBottomCustomers(month, year, product, 'bottom');
                handled = true;
            } else if (/top\s*5.*states/i.test(query)) {
                showTopBottomStates(month, year, product, 'top');
                handled = true;
            } else if (/bottom\s*5.*states/i.test(query)) {
                showTopBottomStates(month, year, product, 'bottom');
                handled = true;
            } else if (/top\s*5.*cities/i.test(query)) {
                showTopBottomCities(month, year, product, 'top');
                handled = true;
            } else if (/bottom\s*5.*cities/i.test(query)) {
                showTopBottomCities(month, year, product, 'bottom');
                handled = true;
            } else if (/average|avg/i.test(query)) {
                showAverageSales(month, year, product);
                handled = true;
            } else if (/city[\s\-]?wise/i.test(query)) {
                showLocationWiseSales('city', month, year, product);
                handled = true;
            } else if (/state[\s\-]?wise/i.test(query)) {
                showLocationWiseSales('state', month, year, product);
                handled = true;
            } else if (/plant.*performance/i.test(query) || /plant.*sales/i.test(query)) {
                showPlantPerformance(month, year, product);
                handled = true;
            } else if (/compare/i.test(query) && /(\d{4})/.test(query)) {
                handleComparisonQuery(query, product);
                handled = true;
            } else if (/monthly\s*(trend|sales)/i.test(query)) {
                let yearMatch = query.match(/(20\d{2})/);
                let yearToUse = yearMatch ? yearMatch[1] : year;
                showMonthlySales(yearToUse, product);
                handled = true;
            } else if (/top\s*customers?\s*per\s*state/i.test(query)) {
                showTopCustomersPerState(month, year, product);
                handled = true;
            } else if (/top\s*customers?\s*per\s*city/i.test(query)) {
                showTopCustomersPerCity(month, year, product);
                handled = true;
            } else if (/quarter.*sales/i.test(query)) {
                showQuarterlySales(month, year, product);
                handled = true;
            } else if (/compare\s+.*\s+and\s+.*\s+cities?/i.test(query)) {
                const match = query.match(/compare\s+(.+?)\s+and\s+(.+?)\s+cities?/i);
                if (match) {
                    compareCities(match[1], match[2], month, year, product);
                    handled = true;
                }
            } else if (/compare\s+.*\s+and\s+.*\s+states?/i.test(query)) {
                const match = query.match(/compare\s+(.+?)\s+and\s+(.+?)\s+states?/i);
                if (match) {
                    compareStates(match[1], match[2], month, year, product);
                    handled = true;
                }
            } else if (/focus.*maharashtra.*karnataka/i.test(query)) {
                compareMaharashtraAndKarnataka(month, year, product);
                handled = true;
            } else if (/SKU.*maharashtra.*karnataka/i.test(query)) {
                showProductSalesForFocusStates(month, year, product);
                handled = true;
            } else if (/sku[-\s]?wise\s+sales/i.test(query)) {
                showSkuWiseSales(month, year, product);
                handled = true;
            } else if (/district.*state.*sales/i.test(query)) {
                showSalesByDistrictAndState(month, year, product);
                handled = true;
            } else if (/state.*product.*sales/i.test(query)) {
                showStateWiseProductSales(month, year, product);
                handled = true;
            } /// === Customer Sales Comparison via Send Button ===
            else if (session.awaitingCustomerName && !session.customerCompare?.name) {
                const inputName = query.trim().toLowerCase();
                const customers = [...new Set(salesData.map(r => r['Customer Name']).filter(Boolean))];

                const matched = customers.find(c => c.toLowerCase().includes(inputName));

                if (matched) {
                    session.customerCompare.name = matched;
                    session.awaitingCustomerName = false;
                    session.awaitingCustomerPeriod = true;
                    addMessage('Bot', `Customer selected: <strong>${matched}</strong><br>Now enter two periods like "2023 and 2024" or "Jan 2023 and Feb 2024"`);
                } else {
                    const suggestions = customers
                        .filter(c => c.toLowerCase().includes(inputName))
                        .slice(0, 5)
                        .join(', ');
                    addMessage('Bot', `Customer not found. ${suggestions ? 'Did you mean: ' + suggestions : 'Try a different name.'}`);
                }

                handled = true;

            } else if (session.awaitingCustomerPeriod && session.customerCompare?.name) {
                const match = query.match(/([a-z]{3,9}?\s*20\d{2}|\d{4})\s*(?:and|vs)\s*([a-z]{3,9}?\s*20\d{2}|\d{4})/i);

                if (!match) {
                    addMessage('Bot', 'Please enter two valid periods like "2023 and 2024" or "Jan 2023 and Feb 2024".');
                } else {
                    const p1 = match[1].trim();
                    const p2 = match[2].trim();

                    const parsePeriod = (p) => {
                        const parts = p.split(' ');
                        if (parts.length === 2) {
                            return { month: monthMap[parts[0].toLowerCase()], year: parts[1] };
                        } else {
                            return { month: null, year: parts[0] };
                        }
                    };

                    const period1 = parsePeriod(p1);
                    const period2 = parsePeriod(p2);

                    session.awaitingCustomerPeriod = false;

                    compareCustomerSales(session.customerCompare.name, period1, period2, product);
                }

                handled = true;
            }

            else {
                const locMatch = query.match(/sales\s+in\s+([a-zA-Z\s]+)/i);
                if (locMatch) {
                    const loc = locMatch[1].trim().toLowerCase();
                    const filtered = filterData(month, year, product);

                    if (filtered.some(r => (r['Ship To City'] || '').toLowerCase().includes(loc))) {
                        showSpecificLocationSales(loc, month, year, product);
                        handled = true;
                    } else if (filtered.some(r => (r['Ship To State Text'] || '').toLowerCase().includes(loc))) {
                        showSpecificStateSales(loc, month, year, product);
                        handled = true;
                    } else {
                        addMessage('Bot', `No sales data found for "${loc}".`);
                        handled = true;
                    }
                }
            }

            if (!handled && query === "") {
                addMessage('Bot', "Please select a query from the drop-down or type your request.");
            }

            if (!handled && query !== "") {
                addMessage('Bot', "I'm unable to provide a result for that query at the moment.");
            }

            // Clear input field after processing
            queryInput.value = '';
        }

        // Add event listeners
        document.getElementById('userInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') handleUserRequest();
        });
        document.getElementById('sendBtn').addEventListener('click', handleUserRequest);

        // Filter sales data by selected filters
        function filterData(month, year, product) {
            return salesData
                .filter(r => (!year || String(r.Year) === String(year)))
                .filter(r => (!month || r.Month_Name === month))
                .filter(r => (!product || r['Product  Hierarchy - Product Variant'] === product));
        }

        // Show total sales for current filters
        function showSalesForSelection(month, year, product) {
            const filtered = filterData(month, year, product);
            const total = filtered.reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            addMessage('Bot', filtered.length
                ? `Total Net Sales Qty: ${total.toLocaleString()} MT`
                : 'No matching data found.');
        }

        // Show top/bottom 5 customers based on sales quantity
        function showTopBottomCustomers(month, year, product, type = 'top') {
            const filtered = filterData(month, year, product);
            const customerSales = {};

            filtered.forEach(r => {
                const code = r['Sold To Party'] || 'Unknown';
                const name = r['Customer Name'] || 'Unknown';
                const qty = +r['Net Sales Qty'] || 0;

                if (!customerSales[code]) {
                    customerSales[code] = { name, qty: 0 };
                }
                customerSales[code].qty += qty;
            });

            let sorted = Object.entries(customerSales).sort((a, b) => b[1].qty - a[1].qty);
            sorted = type === 'bottom' ? sorted.slice(-5) : sorted.slice(0, 5);

            let msg = `<h3 class="font-semibold mb-1">${type === 'top' ? 'Top' : 'Bottom'} 5 Customers</h3>`;
            msg += `<table class="min-w-full text-sm mb-4 border border-black border-collapse">

    <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">Customer Name</th>
            <th class="border border-black px-2 py-1">Customer Code</th>
            <th class="border border-black px-2 py-1">Sales Qty (MT)</th>
        </tr>`;
            sorted.forEach(([code, data]) => {
                msg += `<tr>
            <td class="border border-black px-2 py-1">${data.name}</td>
            <td class="border border-black px-2 py-1">${code}</td>
            <td class="border border-black px-2 py-1">${data.qty.toLocaleString()}</td>
        </tr>`;
            });
            msg += `</table>`;

            addMessage('Bot', msg);
        }

        function showTopBottomStates(month, year, product, type = 'top') {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No state data found.');

            const stateSales = {};
            filtered.forEach(r => {
                const state = r['Ship To State Text'] || 'Unknown';
                stateSales[state] = (stateSales[state] || 0) + (+r['Net Sales Qty'] || 0);
            });

            const sorted = Object.entries(stateSales).sort((a, b) => b[1] - a[1]);
            const selectedStates = type === 'top' ? sorted.slice(0, 5) : sorted.slice(-5).reverse();
            const title = `${type === 'top' ? 'Top' : 'Bottom'} 5 States`;

            let table = `<h3 class="font-semibold mb-1">${title}</h3>`;
            table += `<table class="min-w-full text-sm mb-4 border border-black border-collapse"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">State</th><th class="border border-black px-2 py-1">Sales</th></tr>`;
            selectedStates.forEach(([state, val]) => {
                table += `<tr><td class="border border-black px-2 py-1">${state}</td><td class="border border-black px-2 py-1">${val.toLocaleString()}</td></tr>`;
            });
            table += '</table>';

            addMessage('Bot', table);
        }

        function showTopBottomCities(month, year, product, type = 'top') {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No city data found.');

            const citySales = {};
            filtered.forEach(r => {
                const city = r['Ship To City'] || 'Unknown';
                citySales[city] = (citySales[city] || 0) + (+r['Net Sales Qty'] || 0);
            });

            const sorted = Object.entries(citySales).sort((a, b) => b[1] - a[1]);
            const selectedCities = type === 'top' ? sorted.slice(0, 5) : sorted.slice(-5).reverse();
            const title = `${type === 'top' ? 'Top' : 'Bottom'} 5 Cities`;

            let table = `<h3 class="font-semibold mb-1">${title}</h3>`;
            table += `<table class="min-w-full text-sm mb-4"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">City</th><th class="border border-black px-2 py-1">Sales</th></tr>`;
            selectedCities.forEach(([city, val]) => {
                table += `<tr><td class="border border-black px-2 py-1">${city}</td><td class="border border-black px-2 py-1">${val.toLocaleString()}</td></tr>`;
            });
            table += '</table>';

            addMessage('Bot', table);
        }

        // Show average sales per customer
        function showAverageSales(month, year, product) {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No data found.');

            const totalSales = filtered.reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            const uniqueCustomers = new Set(filtered.map(r => r['Customer Name'])).size;
            if (!uniqueCustomers) return addMessage('Bot', 'No valid customer data.');

            const avg = totalSales / uniqueCustomers;
            addMessage('Bot', `Average Net Sales Qty: ${avg.toFixed(2)} MT`);
        }

        // Show sales aggregated by city or state
        function showLocationWiseSales(type, month, year, product) {
            const key = type === 'state' ? 'Ship To State Text' : 'Ship To City';
            const filtered = filterData(month, year, product);
            const locSales = {};

            filtered.forEach(r => {
                const loc = r[key] || 'Unknown';
                locSales[loc] = (locSales[loc] || 0) + (+r['Net Sales Qty'] || 0);
            });

            const sorted = Object.entries(locSales).sort((a, b) => b[1] - a[1]);
            if (!sorted.length) return addMessage('Bot', `No ${type}-wise data found.`);

            let table = `<table class="min-w-full text-sm"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">${type.charAt(0).toUpperCase() + type.slice(1)}</th><th class="border border-black px-2 py-1">Sales</th></tr>`;
            sorted.forEach(([loc, qty]) => {
                table += `<tr><td class="border border-black px-2 py-1">${loc}</td><td class="border border-black px-2 py-1">${qty.toLocaleString()}</td></tr>`;
            });
            table += '</table>';
            addMessage('Bot', `<h3 class="font-semibold mb-1">${type.charAt(0).toUpperCase() + type.slice(1)}-wise Sales</h3>` + table);

        }

        // Show total sales for a specific city
        function showSpecificLocationSales(queryCity, month, year, product) {
            const filtered = filterData(month, year, product);
            const lowerQuery = queryCity.toLowerCase();
            const match = filtered.find(r => (r['Ship To City'] || '').toLowerCase() === lowerQuery);
            if (!match) return addMessage('Bot', `No sales data found for "${queryCity}".`);
            const city = match['Ship To City'];
            const total = filtered
                .filter(r => (r['Ship To City'] || '').toLowerCase() === lowerQuery)
                .reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            addMessage('Bot', `Total sales in ${city}: ${total.toLocaleString()} MT`);
        }

        // Show total sales for a specific state
        function showSpecificStateSales(queryState, month, year, product) {
            const filtered = filterData(month, year, product);
            const lowerQuery = queryState.toLowerCase();
            const match = filtered.find(r => (r['Ship To State Text'] || '').toLowerCase() === lowerQuery);
            if (!match) return addMessage('Bot', `No sales data found for "${queryState}".`);
            const state = match['Ship To State Text'];
            const total = filtered
                .filter(r => (r['Ship To State Text'] || '').toLowerCase() === lowerQuery)
                .reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            addMessage('Bot', `Total sales in ${state}: ${total.toLocaleString()} MT`);
        }

        // Map month names to standard abbreviations
        const session = {};

        const monthMap = {
            january: "Jan", february: "Feb", march: "Mar", april: "Apr",
            may: "May", june: "Jun", july: "Jul", august: "Aug",
            september: "Sep", october: "Oct", november: "Nov", december: "Dec",
            jan: "Jan", feb: "Feb", mar: "Mar", apr: "Apr",
            jun: "Jun", jul: "Jul", aug: "Aug", sep: "Sep",
            oct: "Oct", nov: "Nov", dec: "Dec"
        };

        // Handle comparison queries (month-year or year-over-year)
        function handleComparisonQuery(query, product) {
            const monthYearMatches = [...query.matchAll(/([A-Za-z]+)[\s\-]?(20\d{2})/g)];
            const yearMatches = [...query.matchAll(/\b(20\d{2})\b/g)];

            // If two valid month-year combos are found
            if (monthYearMatches.length >= 2) {
                const [, m1, y1] = monthYearMatches[0];
                const [, m2, y2] = monthYearMatches[1];
                const month1 = monthMap[m1.toLowerCase()];
                const month2 = monthMap[m2.toLowerCase()];
                if (month1 && month2) {
                    return compareSales(month1, y1, month2, y2, product);
                }
            }

            // If at least two years are present
            if (yearMatches.length >= 2) {
                let [year1, year2] = [yearMatches[0][1], yearMatches[1][1]];
                if (year1 === year2) {
                    return addMessage('Bot', 'Please choose two different years to compare.');
                }
                if (year2 < year1) [year1, year2] = [year2, year1];
                return compareSalesByYear(year1, year2, product);
            }

            // Give guidance if input format is unclear
            addMessage('Bot', `To compare, specify either:
‚Ä¢ Two full month‚Äëyears (e.g., "Compare Jan 2023 with Mar 2024"), or
‚Ä¢ Two years (e.g., "Compare 2023 with 2024").`);
        }

        // Compare two specific month-year periods
        function compareSales(month1, year1, month2, year2, product) {
            const normalizeMonth = (m) => {
                const map = {
                    jan: "Jan", january: "Jan", feb: "Feb", february: "Feb",
                    mar: "Mar", march: "Mar", apr: "Apr", april: "Apr",
                    may: "May", jun: "Jun", june: "Jun", jul: "Jul", july: "Jul",
                    aug: "Aug", august: "Aug", sep: "Sep", sept: "Sep", september: "Sep",
                    oct: "Oct", october: "Oct", nov: "Nov", november: "Nov",
                    dec: "Dec", december: "Dec"
                };
                return m ? map[m.toLowerCase()] || m : null;
            };

            const getSortableValue = (month, year) => {
                const monthOrder = {
                    Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6,
                    Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12
                };
                const m = month ? monthOrder[month] : 0;
                return parseInt(year) * 100 + m;
            };

            const m1 = normalizeMonth(month1);
            const m2 = normalizeMonth(month2);

            const key1 = getSortableValue(m1, year1);
            const key2 = getSortableValue(m2, year2);

            let earlier = { month: m1, year: year1 };
            let later = { month: m2, year: year2 };

            if (key1 > key2) {
                [earlier, later] = [later, earlier];
            }

            const sales1 = filterData(earlier.month, earlier.year, product).reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            const sales2 = filterData(later.month, later.year, product).reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);

            const label1 = earlier.month ? `${earlier.month} ${earlier.year}` : earlier.year;
            const label2 = later.month ? `${later.month} ${later.year}` : later.year;

            let percentChange = 'N/A';
            let colorClass = '';

            if (sales1 !== 0) {
                const change = ((sales2 - sales1) / sales1) * 100;
                const formattedChange = change.toFixed(2) + '%';
                colorClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                percentChange = `<span class="${colorClass}">${formattedChange}</span>`;
            }

            const table = `
        <table class="min-w-full text-sm">
          <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Period</th><th class="border border-black px-2 py-1">Sales</th></tr>
          <tr><td class="border border-black px-2 py-1">${label1}</td><td class="border border-black px-2 py-1">${sales1.toLocaleString()}</td></tr>
          <tr><td class="border border-black px-2 py-1">${label2}</td><td class="border border-black px-2 py-1">${sales2.toLocaleString()}</td></tr>
        </table>
        <div class="mt-2 text-sm text-gray-700">Percentage Change: <strong>${percentChange}</strong></div>
    `;

            addMessage('Bot', `<h3 class="font-semibold mb-1">Month-wise Sales Comparison</h3>` + table);
        }

        // Compare total sales between two years
        function compareSalesByYear(year1, year2, product) {
            const sales1 = filterData(null, year1, product).reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            const sales2 = filterData(null, year2, product).reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);

            let percentChange = 'N/A';
            let colorClass = '';

            if (sales1 !== 0) {
                const change = ((sales2 - sales1) / sales1) * 100;
                const formattedChange = change.toFixed(2) + '%';
                colorClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                percentChange = `<span class="${colorClass}">${formattedChange}</span>`;
            }

            const table = `
    <table class="min-w-full text-sm">
      <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Year</th><th class="border border-black px-2 py-1">Sales</th></tr>
      <tr><td class="border border-black px-2 py-1">${year1}</td><td class="border border-black px-2 py-1">${sales1.toLocaleString()}</td></tr>
      <tr><td class="border border-black px-2 py-1">${year2}</td><td class="border border-black px-2 py-1">${sales2.toLocaleString()}</td></tr>
    </table>
    <div class="mt-2 text-sm text-gray-700">Percentage Change: <strong>${percentChange}</strong></div>
  `;

            addMessage('Bot', `<h3 class="font-semibold mb-1">Year-wise Sales Comparison</h3>` + table);

        }

        // Show monthly sales for a given year
        function showMonthlySales(year, product) {
            const filtered = filterData(null, year, product);
            if (!filtered.length) return addMessage('Bot', `No data found for ${year}.`);

            // Map to store month totals
            const monthlyTotals = {};
            filtered.forEach(r => {
                const month = r.Month_Name;
                monthlyTotals[month] = (monthlyTotals[month] || 0) + (+r['Net Sales Qty'] || 0);
            });

            // Sort by month order
            const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const sorted = Object.entries(monthlyTotals).sort((a, b) =>
                monthOrder.indexOf(a[0]) - monthOrder.indexOf(b[0])
            );

            // Create HTML table
            let table = `<table class="min-w-full text-sm"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Month</th><th class="border border-black px-2 py-1">Sales Qty</th></tr>`;
            sorted.forEach(([month, qty]) => {
                table += `<tr><td class="border border-black px-2 py-1">${month}</td><td class="border border-black px-2 py-1">${qty.toLocaleString()}</td></tr>`;
            });
            table += `</table>`;

            addMessage('Bot', `<h3 class="font-semibold mb-1">Monthly Sales for ${year}</h3>` + table);

        }

        function showPlantPerformance(month, year, product) {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No plant data found for the selected filters.');

            const plantSales = {};

            filtered.forEach(r => {
                const plant = r['Plant_Name'];
                const qty = +r['Net Sales Qty'] || 0;

                if (!plant || plant.trim() === '') return;

                const cleanPlant = plant.trim();
                plantSales[cleanPlant] = (plantSales[cleanPlant] || 0) + qty;
            });

            const allPlants = Object.entries(plantSales)
                .sort((a, b) => a[0].localeCompare(b[0])); // sort alphabetically by name

            if (allPlants.length === 0) {
                return addMessage('Bot', 'No valid plant names with sales found.');
            }

            let title = `Plant-wise Sales (${[
                month ? 'Month: ' + month : '',
                year ? 'Year: ' + year : '',
                product ? 'Product: ' + product : ''
            ].filter(Boolean).join(', ')})`;

            let table = `<h3 class="font-semibold mb-1">${title}</h3>`;
            table += `<table class="min-w-full text-sm mb-4 border border-black border-collapse">
              <tr style="background-color: #f3f4f6;">
                <th class="border border-black px-2 py-1">Plant Name</th>
                <th class="border border-black px-2 py-1">Net Sales Qty</th>
              </tr>`;
            allPlants.forEach(([plant, qty]) => {
                table += `<tr><td class="border border-black px-2 py-1">${plant}</td><td class="border border-black px-2 py-1">${qty.toLocaleString()}</td></tr>`;
            });
            table += `</table>`;

            addMessage('Bot', table);

        }

        function showTopCustomersPerState(month, year, product) {
            const filtered = filterData(month, year, product);
            const stateCustomerMap = {};

            // Group customer sales per state
            filtered.forEach(r => {
                const state = r['Ship To State Text'] || 'Unknown';
                const name = r['Customer Name'] || 'Unknown';
                const code = r['Sold To Party'] || 'N/A';
                const qty = +r['Net Sales Qty'] || 0;

                if (!stateCustomerMap[state]) stateCustomerMap[state] = {};
                if (!stateCustomerMap[state][name]) {
                    stateCustomerMap[state][name] = { code: code, qty: 0 };
                }
                stateCustomerMap[state][name].qty += qty;
            });

            // Get top customer per state
            const topCustomers = Object.entries(stateCustomerMap).map(([state, customers]) => {
                const sorted = Object.entries(customers).sort((a, b) => b[1].qty - a[1].qty);
                const [custName, info] = sorted[0]; // only top
                return {
                    state,
                    customer: custName,
                    code: info.code,
                    qty: info.qty
                };
            });

            // Sort by sales qty descending
            topCustomers.sort((a, b) => b.qty - a.qty);

            // Build HTML table
            let msg = `<h3 class="font-semibold mb-1">Top Customers per State</h3>
    <table class="min-w-full text-sm mb-4 border border-black border-collapse">
        <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">State</th>
            <th class="border border-black px-2 py-1">Customer Name</th>
            <th class="border border-black px-2 py-1">Customer Code</th>
            <th class="border border-black px-2 py-1">Sales Qty (MT)</th>
        </tr>`;

            topCustomers.forEach(row => {
                msg += `
        <tr>
            <td class="border border-black px-2 py-1">${row.state}</td>
            <td class="border border-black px-2 py-1">${row.customer}</td>
            <td class="border border-black px-2 py-1">${row.code}</td>
            <td class="border border-black px-2 py-1">${row.qty.toLocaleString()}</td>
        </tr>`;
            });

            msg += '</table>';
            addMessage('Bot', msg);
        }



        function showTopCustomersPerCity(month, year, product) {
            const filtered = filterData(month, year, product);
            const cityCustomerMap = {};

            // Aggregate customer sales per city
            filtered.forEach(r => {
                const city = r['Ship To City'] || 'Unknown';
                const name = r['Customer Name'] || 'Unknown';
                const code = r['Sold To Party'] || 'N/A';
                const qty = +r['Net Sales Qty'] || 0;

                if (!cityCustomerMap[city]) cityCustomerMap[city] = {};
                if (!cityCustomerMap[city][name]) {
                    cityCustomerMap[city][name] = { code: code, qty: 0 };
                }
                cityCustomerMap[city][name].qty += qty;
            });

            // Get top customer per city
            const topCustomers = Object.entries(cityCustomerMap).map(([city, customers]) => {
                const sorted = Object.entries(customers).sort((a, b) => b[1].qty - a[1].qty);
                const [custName, info] = sorted[0]; // only top
                return {
                    city,
                    customer: custName,
                    code: info.code,
                    qty: info.qty
                };
            });

            // Sort by sales qty in descending order
            topCustomers.sort((a, b) => b.qty - a.qty);

            // Build HTML table
            let msg = `<h3 class="font-semibold mb-1">Top Customers per City</h3>
    <table class="min-w-full text-sm mb-4 border border-black border-collapse">
        <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">City</th>
            <th class="border border-black px-2 py-1">Customer Name</th>
            <th class="border border-black px-2 py-1">Customer Code</th>
            <th class="border border-black px-2 py-1">Sales Qty (MT)</th>
        </tr>`;

            topCustomers.forEach(row => {
                msg += `
        <tr>
            <td class="border border-black px-2 py-1">${row.city}</td>
            <td class="border border-black px-2 py-1">${row.customer}</td>
            <td class="border border-black px-2 py-1">${row.code}</td>
            <td class="border border-black px-2 py-1">${row.qty.toLocaleString()}</td>
        </tr>`;
            });

            msg += '</table>';
            addMessage('Bot', msg);
        }

        function showQuarterlySales(month, year, product) {
            const filtered = filterData(month, year, product);
            if (!filtered.length) return addMessage('Bot', 'No data found.');

            const quarterSales = {};
            filtered.forEach(r => {
                const quarter = r['Qtr No'] || 'Q?';
                quarterSales[quarter] = (quarterSales[quarter] || 0) + (+r['Net Sales Qty'] || 0);
            });

            const sorted = Object.entries(quarterSales).sort((a, b) => a[0] - b[0]);

            let table = `<h3 class="font-semibold mb-1">Quarter-wise Sales</h3>`;
            table += `<table class="min-w-full text-sm mb-4"><tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Quarter</th><th class="border border-black px-2 py-1">Sales</th></tr>`;
            sorted.forEach(([qtr, val]) => {
                table += `<tr><td class="border border-black px-2 py-1">Q${qtr}</td><td class="border border-black px-2 py-1">${val.toLocaleString()}</td></tr>`;
            });
            table += '</table>';

            addMessage('Bot', table);
        }

        function compareCities(city1, city2, month, year, product) {
            const filtered = filterData(month, year, product);
            let total1 = 0, total2 = 0;

            filtered.forEach(r => {
                const city = (r['Ship To City'] || '').toLowerCase();
                const qty = +r['Net Sales Qty'] || 0;
                if (city.includes(city1.toLowerCase())) total1 += qty;
                if (city.includes(city2.toLowerCase())) total2 += qty;
            });

            const table = `
    <table class="min-w-full text-sm">
        <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">City</th><th class="border border-black px-2 py-1">Sales</th></tr>
        <tr><td class="border border-black px-2 py-1">${city1}</td><td class="border border-black px-2 py-1">${total1.toLocaleString()}</td></tr>
        <tr><td class="border border-black px-2 py-1">${city2}</td><td class="border border-black px-2 py-1">${total2.toLocaleString()}</td></tr>
    </table>
    `;

            addMessage('Bot', `<h3 class="font-semibold mb-1">City-wise Sales Comparison</h3>` + table);

        }

        function compareStates(state1, state2, month, year, product) {
            const filtered = filterData(month, year, product);
            let total1 = 0, total2 = 0;

            filtered.forEach(r => {
                const state = (r['Ship To State Text'] || '').toLowerCase();
                const qty = +r['Net Sales Qty'] || 0;
                if (state.includes(state1.toLowerCase())) total1 += qty;
                if (state.includes(state2.toLowerCase())) total2 += qty;
            });

            const table = `
    <table class="min-w-full text-sm">
        <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">State</th><th class="border border-black px-2 py-1">Sales</th></tr>
        <tr><td class="border border-black px-2 py-1">${state1}</td><td class="border border-black px-2 py-1">${total1.toLocaleString()}</td></tr>
        <tr><td class="border border-black px-2 py-1">${state2}</td><td class="border border-black px-2 py-1">${total2.toLocaleString()}</td></tr>
    </table>
    `;

            addMessage('Bot', `<h3 class="font-semibold mb-1">State-wise Sales Comparison</h3>` + table);
        }

        function compareMaharashtraAndKarnataka(month, year, product) {
            const filtered = filterData(month, year, product);
            let totalMH = 0, totalKA = 0;

            filtered.forEach(r => {
                const state = (r['Ship To State Text'] || '').toLowerCase();
                const qty = +r['Net Sales Qty'] || 0;
                if (state.includes('maharashtra')) totalMH += qty;
                if (state.includes('karnataka')) totalKA += qty;
            });

            const msg = `
        Maharashtra: ${totalMH.toLocaleString()} MT<br>
        Karnataka: ${totalKA.toLocaleString()} MT
    `;
            addMessage('Bot', `<h3 class="font-semibold mb-1">Focus States Comparison</h3><div>${msg}</div>`);

        }

        function showProductSalesForFocusStates(month, year, product) {
            const filtered = filterData(month, year, product);
            const mhProducts = {};
            const kaProducts = {};

            filtered.forEach(r => {
                const state = (r['Ship To State Text'] || '').toLowerCase();
                const desc = r['Product Description'] || 'Unknown';
                const qty = +r['Net Sales Qty'] || 0;

                if (state.includes('maharashtra')) {
                    mhProducts[desc] = (mhProducts[desc] || 0) + qty;
                } else if (state.includes('karnataka')) {
                    kaProducts[desc] = (kaProducts[desc] || 0) + qty;
                }
            });

            // Combine all product names and sort by total sales (MH + KA) descending
            const allProducts = new Set([...Object.keys(mhProducts), ...Object.keys(kaProducts)]);
            const sortedProducts = Array.from(allProducts).sort((a, b) => {
                const totalA = (mhProducts[a] || 0) + (kaProducts[a] || 0);
                const totalB = (mhProducts[b] || 0) + (kaProducts[b] || 0);
                return totalB - totalA;
            });

            let table = `
    <h3 class="font-semibold mb-1">SKU-wise Sales in Focus States</h3>
    <table class="min-w-full text-sm mb-4 border border-black border-collapse">
        <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">Product Description</th>
            <th class="border border-black px-2 py-1">Maharashtra</th>
            <th class="border border-black px-2 py-1">Karnataka</th>
        </tr>
    `;

            sortedProducts.forEach(desc => {
                const mhQty = mhProducts[desc] || 0;
                const kaQty = kaProducts[desc] || 0;
                table += `
        <tr>
            <td class="border border-black px-2 py-1">${desc}</td>
            <td class="border border-black px-2 py-1">${mhQty.toLocaleString()}</td>
            <td class="border border-black px-2 py-1">${kaQty.toLocaleString()}</td>
        </tr>`;
            });

            table += '</table>';
            addMessage('Bot', table);
        }

        function showSkuWiseSales(month, year, product) {
            const filtered = filterData(month, year, product);
            const skuSales = {};

            filtered.forEach(r => {
                const sku = r['Product Description'] || 'Unknown';
                const qty = +r['Net Sales Qty'] || 0;
                skuSales[sku] = (skuSales[sku] || 0) + qty;
            });

            const sortedSkus = Object.entries(skuSales)
                .sort((a, b) => b[1] - a[1]); // Sort by sales descending

            let table = `
    <h3 class="font-semibold mb-1">SKU-wise Sales</h3>
    <table class="min-w-full text-sm mb-4 border border-black border-collapse">
        <tr style="background-color: #f3f4f6;">
            <th class="border border-black px-2 py-1">Product Description (SKU)</th>
            <th class="border border-black px-2 py-1">Total Sales</th>
        </tr>
    `;

            sortedSkus.forEach(([sku, qty]) => {
                table += `
        <tr>
            <td class="border border-black px-2 py-1">${sku}</td>
            <td class="border border-black px-2 py-1">${qty.toLocaleString()}</td>
        </tr>`;
            });

            table += '</table>';
            addMessage('Bot', table);
        }

        function showSalesByDistrictAndState(month, year, product) {
            const filtered = filterData(month, year, product);
            const districtData = {};

            filtered.forEach(r => {
                const district = r['Sales District'] || 'Unknown';
                const state = r['Ship To State Text'] || 'Unknown';
                const qty = +r['Net Sales Qty'] || 0;

                if (!districtData[district]) {
                    districtData[district] = { total: 0, states: {} };
                }

                districtData[district].total += qty;
                districtData[district].states[state] = (districtData[district].states[state] || 0) + qty;
            });

            const sortedDistricts = Object.entries(districtData).sort((a, b) => b[1].total - a[1].total);

            let msg = `<h3 class="font-semibold mb-1">Sales District-wise Breakdown (with States)</h3>`;

            sortedDistricts.forEach(([district, data]) => {
                msg += `<div class="mb-3"><strong>${district}</strong> - <span style="font-weight: bold; background-color: #facc15; padding: 2px 6px; border-radius: 4px;"> Total Sales: ${data.total.toLocaleString()} MT</span>`;
                msg += `<table class="min-w-full text-sm mt-1">
                <tr style="background-color: #f3f4f6;">
                    <th class="border border-black px-2 py-1">State</th>
                    <th class="border border-black px-2 py-1">Sales</th>
                </tr>`;
                const sortedStates = Object.entries(data.states).sort((a, b) => b[1] - a[1]);
                sortedStates.forEach(([state, qty]) => {
                    msg += `<tr>
                        <td class="border border-black px-2 py-1">${state}</td>
                        <td class="border border-black px-2 py-1">${qty.toLocaleString()}</td>
                    </tr>`;
                });
                msg += `</table></div>`;
            });

            addMessage('Bot', msg);
        }

        function showStateWiseProductSales(month, year, product) {
            const filtered = filterData(month, year, product);
            const stateData = {};

            filtered.forEach(r => {
                const state = r['Ship To State Text'] || 'Unknown';
                const sku = r['Product Description'] || 'Unknown';
                const qty = +r['Net Sales Qty'] || 0;

                if (!stateData[state]) {
                    stateData[state] = { total: 0, skus: {} };
                }

                stateData[state].total += qty;
                stateData[state].skus[sku] = (stateData[state].skus[sku] || 0) + qty;
            });

            const sortedStates = Object.entries(stateData).sort((a, b) => b[1].total - a[1].total);

            let msg = `<h3 class="font-semibold mb-1">State-wise Sales with Product Breakdown</h3>`;

            sortedStates.forEach(([state, data]) => {
                msg += `<div class="mt-4 mb-3"><strong>${state}</strong> - <span style="font-weight: bold; background-color: #facc15; padding: 2px 6px; border-radius: 4px;">Total Sales: ${data.total.toLocaleString()} MT</span></div>`;
                msg += `<table class="min-w-full text-sm mt-1">
                <tr style="background-color: #f3f4f6;">
                    <th class="border border-black px-2 py-1">Product Description</th>
                    <th class="border border-black px-2 py-1">Sales Qty</th>
                </tr>`;
                const sortedSkus = Object.entries(data.skus).sort((a, b) => b[1] - a[1]);
                sortedSkus.forEach(([sku, qty]) => {
                    msg += `<tr>
                        <td class="border border-black px-2 py-1">${sku}</td>
                        <td class="border border-black px-2 py-1">${qty.toLocaleString()}</td>
                    </tr>`;
                });
                msg += `</table></div>`;
            });

            addMessage('Bot', msg);
        }
        const normalizeMonth = (m) => {
            const map = {
                jan: "Jan", january: "Jan",
                feb: "Feb", february: "Feb",
                mar: "Mar", march: "Mar",
                apr: "Apr", april: "Apr",
                may: "May",
                jun: "Jun", june: "Jun",
                jul: "Jul", july: "Jul",
                aug: "Aug", august: "Aug",
                sep: "Sep", sept: "Sep", september: "Sep",
                oct: "Oct", october: "Oct",
                nov: "Nov", november: "Nov",
                dec: "Dec", december: "Dec"
            };
            return map[m.toLowerCase()] || m;
        };

        function compareCustomerSales(customerName, period1, period2, product) {
            const getSales = (month, year) => {
                const normalizedMonth = month ? normalizeMonth(month) : null;
                return filterData(normalizedMonth, year, product)

                    .filter(r => (r['Customer Name'] || '').toLowerCase() === customerName.toLowerCase())
                    .reduce((sum, r) => sum + (+r['Net Sales Qty'] || 0), 0);
            };
            const p1 = { ...period1 };
            const p2 = { ...period2 };

            // Normalize month names
            p1.month = p1.month ? normalizeMonth(p1.month) : null;
            p2.month = p2.month ? normalizeMonth(p2.month) : null;

            // Helper to get a comparable number for sorting
            const getSortableValue = (p) => {
                const monthMap = { Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6, Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12 };
                const m = p.month ? monthMap[p.month.slice(0, 3)] : 0;
                return parseInt(p.year) * 100 + m;
            };

            // Sort periods chronologically
            let earlier = p1, later = p2;
            if (getSortableValue(p1) > getSortableValue(p2)) {
                [earlier, later] = [p2, p1];
            }

            // Now fetch sales using sorted periods
            const sales1 = getSales(earlier.month, earlier.year);
            const sales2 = getSales(later.month, later.year);

            const label1 = earlier.month ? `${earlier.month.toLowerCase()} ${earlier.year}` : earlier.year;
            const label2 = later.month ? `${later.month.toLowerCase()} ${later.year}` : later.year;

            let percentChange = 'N/A';
            let colorClass = '';

            if (sales1 !== 0) {
                const change = ((sales2 - sales1) / sales1) * 100;
                const formattedChange = change.toFixed(2) + '%';
                colorClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                percentChange = `<span class="${colorClass}">${formattedChange}</span>`;
            }

            const table = `
        <h3 class="font-semibold mb-1">Sales Comparison for <strong>${customerName}</strong></h3>
        <table class="min-w-full text-sm">
            <tr style="background-color: #f3f4f6;"><th class="border border-black px-2 py-1">Period</th><th class="border border-black px-2 py-1">Sales Qty</th></tr>
            <tr><td class="border border-black px-2 py-1">${label1}</td><td class="border border-black px-2 py-1">${sales1.toLocaleString()}</td></tr>
            <tr><td class="border border-black px-2 py-1">${label2}</td><td class="border border-black px-2 py-1">${sales2.toLocaleString()}</td></tr>
        </table>
        <div class="mt-2 text-sm text-gray-700">Percentage Change: <strong>${percentChange}</strong></div>
    `;

            addMessage('Bot', table);

            session.customerCompare = {};
            session.awaitingCustomerName = false;
            session.awaitingCustomerPeriod = false;
        }



        // Utility: Add messages to chat window
       function addMessage(sender, text) {
    const chatWindow = document.getElementById('chatWindow');
    const div = document.createElement('div');
    div.className = sender === 'You' ? 'text-right mb-2' : 'text-left mb-2';

    const now = new Date();
    const timestamp = now.toLocaleString('en-GB', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
    }).replace(',', '');

    div.innerHTML = `<span class="font-bold">${sender}</span> <span class="text-gray-500">[${timestamp}]</span>: ${text}`;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

        // This should be in the SEND button handler, NOT querySelect change

        // Trigger handleUserRequest when Enter is pressed and a dropdown is focused
        document.addEventListener('keydown', function (e) {
            const isDropdownFocused = ['querySelect', 'yearSelect', 'monthSelect', 'productSelect'].includes(document.activeElement.id);
            if (e.key === 'Enter' && isDropdownFocused) {
                handleUserRequest();
            }
        });

        function handleUserRequest() {
            const query = document.getElementById('querySelect').value;
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            const product = document.getElementById('productSelect').value;
            const userText = document.getElementById('userInput').value.trim();

            let handled = false;

            // Step 1: Handle customer comparison inputs
            if (session.awaitingCustomerName && userText) {
                session.customerCompare.name = userText;
                session.awaitingCustomerName = false;
                session.awaitingCustomerPeriod = 'first';
                addMessage('Bot', 'Now enter two periods like "2023 and 2024" or "Jan 2023 and Feb 2024":');
                document.getElementById('userInput').value = '';
                return;
            }

            if (session.awaitingCustomerPeriod && userText) {
                const parts = userText.toLowerCase().split(' and ');
                if (parts.length !== 2) {
                    addMessage('Bot', 'Please enter two periods like "2023 and 2024" or "Jan 2023 and Feb 2024"');
                    return;
                }

                const extractPeriod = (str) => {
                    const tokens = str.trim().split(' ');
                    return {
                        month: tokens.length === 2 ? tokens[0] : null,
                        year: tokens.length === 2 ? tokens[1] : tokens[0]
                    };
                };

                session.customerCompare.period1 = extractPeriod(parts[0]);
                session.customerCompare.period2 = extractPeriod(parts[1]);

                compareCustomerSales(
                    session.customerCompare.name,
                    session.customerCompare.period1,
                    session.customerCompare.period2,
                    product
                );
                session.awaitingCustomerPeriod = false;
                document.getElementById('userInput').value = '';
                return;
            }
            function showPlantSalesToNonFocusStates(month, year, product) {
                const filtered = filterData(month, year, product);
                if (!filtered.length) return addMessage('Bot', 'No data found.');

                const plantStatesMap = {};
                const salesBreakdown = {};

                // Step 1: Map Plant to its most common destination state (assume home state)
                filtered.forEach(r => {
                    const plant = r['Plant_Name'];
                    const state = r['Ship To State Text'];
                    if (!plant || !state) return;

                    if (!plantStatesMap[plant]) plantStatesMap[plant] = {};
                    plantStatesMap[plant][state] = (plantStatesMap[plant][state] || 0) + 1;
                });

                const plantHomeStates = {};
                for (const plant in plantStatesMap) {
                    const stateCounts = plantStatesMap[plant];
                    const homeState = Object.entries(stateCounts).sort((a, b) => b[1] - a[1])[0][0];
                    plantHomeStates[plant] = homeState;
                }

                // Step 2: Capture sales to non-home states
                filtered.forEach(r => {
                    const plant = r['Plant_Name'];
                    const toState = r['Ship To State Text'];
                    const qty = +r['Net Sales Qty'] || 0;
                    if (!plant || !toState || !qty) return;

                    const home = plantHomeStates[plant];
                    if (toState !== home) {
                        if (!salesBreakdown[plant]) salesBreakdown[plant] = {};
                        salesBreakdown[plant][toState] = (salesBreakdown[plant][toState] || 0) + qty;
                    }
                });

                // Step 3: Build output
                let output = `<h3 class="font-semibold mb-1">Plant-wise Sales to Non-Focus States</h3>`;

                for (const plant in salesBreakdown) {
                    const stateData = salesBreakdown[plant];
                    const sortedStates = Object.entries(stateData).sort((a, b) => b[1] - a[1]);

                    output += `<div class="mb-2"><strong>${plant}</strong>`;
                    output += `<table class="min-w-full text-sm mt-1 mb-3">
            <tr style="background-color: #f3f4f6;">
                <th class="border border-black px-2 py-1">State</th>
                <th class="border border-black px-2 py-1">Sales Qty</th>
            </tr>`;

                    sortedStates.forEach(([state, qty]) => {
                        output += `<tr>
                <td class="border border-black px-2 py-1">${state}</td>
                <td class="border border-black px-2 py-1">${qty.toLocaleString()}</td>
            </tr>`;
                    });

                    output += `</table></div>`;
                }

                if (!Object.keys(salesBreakdown).length) {
                    addMessage('Bot', 'No sales found to non-focus states.');
                } else {
                    addMessage('Bot', output);
                }
            }


            // Step 2: Handle regular queries
            switch (query) {
                case 'sales': showSalesForSelection(month, year, product); handled = true; break;
                case 'avg': showAverageSales(month, year, product); handled = true; break;
                case 'monthly': showMonthlySales(year, product); handled = true; break;
                case 'citywise': showLocationWiseSales('city', month, year, product); handled = true; break;
                case 'statewise': showLocationWiseSales('state', month, year, product); handled = true; break;
                case 'top5cities': showTopBottomCities(month, year, product, 'top'); handled = true; break;
                case 'top5states': showTopBottomStates(month, year, product, 'top'); handled = true; break;
                case 'bottom5cities': showTopBottomCities(month, year, product, 'bottom'); handled = true; break;
                case 'bottom5states': showTopBottomStates(month, year, product, 'bottom'); handled = true; break;
                case 'top5customers': showTopBottomCustomers(month, year, product, 'top'); handled = true; break;
                case 'bottom5customers': showTopBottomCustomers(month, year, product, 'bottom'); handled = true; break;
                case 'specificcity':
                    const cityOptions = [...new Set(salesData.map(r => r['Ship To City']).filter(Boolean))].sort();
                    openModal('Sales in Specific City', [
                        { id: 'cityName', placeholder: 'Select City', type: 'select', options: cityOptions }
                    ], (city) => {
                        showSpecificLocationSales(city, month, year, product);
                    });
                    handled = true;
                    break;
                case 'specificstate':
                    const stateOptions = [...new Set(salesData.map(r => r['Ship To State Text']).filter(Boolean))].sort();
                    openModal('Sales in Specific State', [
                        { id: 'stateName', placeholder: 'Select State', type: 'select', options: stateOptions }
                    ], (state) => {
                        showSpecificStateSales(state, month, year, product);
                    });
                    handled = true;
                    break;
                case 'compare':
                    const monthsList = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const yearsList = [...new Set(salesData.map(r => r['Year']).filter(Boolean))].sort((a, b) => b - a);

                    openModal('Compare Two Periods', [
                        { id: 'month1', placeholder: 'Select First Month (Optional)', type: 'select', options: monthsList },
                        { id: 'year1', placeholder: 'Select First Year', type: 'select', options: yearsList },
                        { id: 'month2', placeholder: 'Select Second Month (Optional)', type: 'select', options: monthsList },
                        { id: 'year2', placeholder: 'Select Second Year', type: 'select', options: yearsList }
                    ], (m1, y1, m2, y2) => {
                        const query = `compare ${m1 ? m1 + ' ' : ''}${y1} and ${m2 ? m2 + ' ' : ''}${y2}`;
                        handleComparisonQuery(query, product);
                    });
                    handled = true;
                    break;
                case 'comparecities':
                    const cities = [...new Set(salesData.map(r => r['Ship To City']).filter(Boolean))].sort();
                    openModal('Compare Two Cities', [
                        { id: 'city1', placeholder: 'Select First City', type: 'select', options: cities },
                        { id: 'city2', placeholder: 'Select Second City', type: 'select', options: cities }
                    ], (c1, c2) => {
                        compareCities(c1, c2, month, year, product);
                    });
                    handled = true;
                    break;
                case 'comparestates':
                    const states = [...new Set(salesData.map(r => r['Ship To State Text']).filter(Boolean))].sort();
                    openModal('Compare Two States', [
                        { id: 'state1', placeholder: 'Select First State', type: 'select', options: states },
                        { id: 'state2', placeholder: 'Select Second State', type: 'select', options: states }
                    ], (s1, s2) => {
                        compareStates(s1, s2, month, year, product);
                    });
                    handled = true;
                    break;
                case 'plant': showPlantPerformance(month, year, product); handled = true; break;
                case 'topcustomersstate': showTopCustomersPerState(month, year, product); handled = true; break;
                case 'topcustomerscity': showTopCustomersPerCity(month, year, product); handled = true; break;
                case 'quarterly': showQuarterlySales(month, year, product); handled = true; break;
                case 'focusstates': compareMaharashtraAndKarnataka(month, year, product); handled = true; break;
                case 'focusproductstates': showProductSalesForFocusStates(month, year, product); handled = true; break;
                case 'skusales': showSkuWiseSales(month, year, product); handled = true; break;
                case 'districtbreakdown': showSalesByDistrictAndState(month, year, product); handled = true; break;
                case 'stateproductbreakdown': showStateWiseProductSales(month, year, product); handled = true; break;
                case 'comparecustomersales':
                    const customerNames = [...new Set(salesData.map(r => r['Customer Name']).filter(Boolean))].sort();
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const years = [...new Set(salesData.map(r => r['Year']).filter(Boolean))].sort((a, b) => b - a);

                    openModal('Compare Customer Sales', [
                        { id: 'customerName', placeholder: 'Select Customer', type: 'select', options: customerNames },
                        { id: 'month1', placeholder: 'Select First Month', type: 'select', options: months },
                        { id: 'year1', placeholder: 'Select First Year', type: 'select', options: years },
                        { id: 'month2', placeholder: 'Select Second Month', type: 'select', options: months },
                        { id: 'year2', placeholder: 'Select Second Year', type: 'select', options: years }
                    ], (customer, p1, p2) => {
                        compareCustomerSales(customer, p1, p2, product);
                    });

                    handled = true;
                    break;

                case 'nonfocusplants':
                    showPlantSalesToNonFocusStates(month, year, product);
                    handled = true;
                    break;
            }

            if (!handled && query === "") {
                addMessage('Bot', "Please select a query from the drop-down or type your request.");
            }

            document.getElementById('userInput').value = '';
        }

        function openModal(title, fields, callback) {
            const container = document.getElementById('modalFields');
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.innerText = title;
            container.innerHTML = '';

            fields.forEach(field => {
                let input;
                if (field.type === 'select') {
                    input = document.createElement('select');
                    input.id = field.id;
                    input.className = 'w-full border border-gray-300 p-2 rounded text-base';
                    input.innerHTML = `<option value="">${field.placeholder}</option>`;
                    field.options.forEach(opt => {
                        input.innerHTML += `<option value="${opt}">${opt}</option>`;
                    });
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = field.placeholder;
                    input.id = field.id;
                    input.className = 'w-full border border-gray-300 p-2 rounded text-sm';
                }

                const wrapper = document.createElement('div');
                wrapper.appendChild(input);
                container.appendChild(wrapper);
            });

            // Show modal
            document.getElementById('inputModal').classList.remove('hidden');

            document.getElementById('modalSubmitBtn').onclick = function () {
                const values = fields.map(f => document.getElementById(f.id).value.trim());
                const queryType = document.getElementById('querySelect').value;

                let isValid = true;

                if (queryType === 'comparecustomersales') {
                    const [customer, m1, y1, m2, y2] = values;
                    if (!customer || !y1 || !y2) {
                        alert('Please select customer and both years (months optional).');
                        isValid = false;
                    } else {
                        callback(customer, { month: m1 || null, year: y1 }, { month: m2 || null, year: y2 });
                    }
                }

                else if (queryType === 'compare') {
                    const [m1, y1, m2, y2] = values;
                    if (!y1 || !y2) {
                        alert('Please select both years (months optional).');
                        isValid = false;
                    } else {
                        const query = `compare ${m1 ? m1 + ' ' : ''}${y1} and ${m2 ? m2 + ' ' : ''}${y2}`;
                        callback(query);
                    }
                }

                else if (queryType === 'comparecities') {
                    const [c1, c2] = values;
                    if (!c1 || !c2) {
                        alert('Please select both cities.');
                        isValid = false;
                    } else {
                        callback(c1, c2);
                    }
                }

                else if (queryType === 'comparestates') {
                    const [s1, s2] = values;
                    if (!s1 || !s2) {
                        alert('Please select both states.');
                        isValid = false;
                    } else {
                        callback(s1, s2);
                    }
                }

                else if (queryType === 'specificstate') {
                    const [state] = values;
                    if (!state) {
                        alert('Please select a state.');
                        isValid = false;
                    } else {
                        callback(state);
                    }
                }

                else if (queryType === 'specificcity') {
                    const [city] = values;
                    if (!city) {
                        alert('Please select a city.');
                        isValid = false;
                    } else {
                        callback(city);
                    }
                }

                // Close modal only if valid
                if (isValid) {
                    document.getElementById('inputModal').classList.add('hidden');
                }
            };

            // Cancel button
            document.getElementById('modalCancelBtn').onclick = function () {
                document.getElementById('inputModal').classList.add('hidden');
            };
        }


        function closeModal() {
            document.getElementById('inputModal').classList.add('hidden');
        }

        function submitModal() {
            const inputs = [...document.querySelectorAll('#modalFields input')].map(i => i.value.trim());
            closeModal();
            if (typeof window.modalCallback === 'function') {
                window.modalCallback(...inputs);
            }
        }

    </script>
    <div id="inputModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md text-black">
            <h2 id="modalTitle" class="text-xl font-semibold mb-4 text-gray-800">Modal Title</h2>
            <div id="modalFields" class="space-y-3"></div>
            <div class="flex justify-end space-x-2 mt-5">
                <button id="modalCancelBtn"
                    class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
                <button id="modalSubmitBtn"
                    class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Submit</button>
            </div>
        </div>
    </div>


</body>


</html>
